<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Listening Experiment v8.0 - Firebase Enhanced</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 900px;
            width: 90%;
            margin: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 35px;
        }

        .header h1 {
            color: #333;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .version-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .firebase-status {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.85em;
            margin-top: 10px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .firebase-status.connected {
            background: #28a745;
        }

        .firebase-status.connecting {
            background: #ffc107;
            color: #333;
        }

        .stage {
            display: none;
        }

        .stage.active {
            display: block;
        }

        .progress-container {
            margin-bottom: 35px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e8ecf4;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.4s ease;
        }

        .question-card {
            background: #f8f9ff;
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .question-number {
            color: #667eea;
            font-weight: 700;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .audio-controls {
            text-align: center;
            margin: 25px 0;
        }

        .play-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            min-width: 240px;
        }

        .play-button:hover {
            background: #5a6fd8;
        }

        .play-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sentence-display {
            font-size: 1.4em;
            margin: 30px 0;
            text-align: center;
            line-height: 2.2;
            padding: 25px;
            background: white;
            border-radius: 16px;
        }

        .input-field {
            border: none;
            border-bottom: 3px solid #667eea;
            background: white;
            font-size: 1.3em;
            padding: 12px 16px;
            margin: 0 10px;
            min-width: 200px;
            max-width: 250px;
            text-align: center;
            outline: none;
            border-radius: 8px 8px 0 0;
        }

        .spell-error-text {
            border-bottom: 3px wavy #e74c3c;
            background-color: rgba(231, 76, 60, 0.08);
            padding: 3px 6px;
            border-radius: 6px;
            cursor: pointer;
        }

        .word-correction-popup {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .correction-option {
            padding: 8px 12px;
            font-weight: 600;
            color: #28a745;
        }

        .next-button, .submit-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            margin: 25px 15px;
        }

        .next-button:hover, .submit-button:hover {
            background: #218838;
        }

        .feedback-section {
            background: #e8f5e8;
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #28a745;
        }

        .survey-section {
            background: #fff3cd;
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #ffc107;
        }

        .survey-question {
            margin: 25px 0;
        }

        .survey-question label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .survey-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .completion-message {
            text-align: center;
            padding: 50px;
            background: #28a745;
            color: white;
            border-radius: 24px;
        }

        .completion-message h2 {
            font-size: 3em;
            margin-bottom: 25px;
        }

        .button-group {
            text-align: center;
            margin-top: 25px;
        }

        .info-text {
            text-align: center;
            color: #666;
            margin: 25px 0;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .mouse-tracking-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéß Audio Listening Experiment <span class="version-badge">v8.0</span></h1>
            <div class="firebase-status connecting" id="firebaseStatus">üîÑ ËØ∑ÂÖàÈÖçÁΩÆFirebase...</div>
            <p class="info-text">ÂÆåÊï¥Êï∞ÊçÆËøΩË∏™Á≥ªÁªü ‚Ä¢ Ëá™Âä®Èü≥È¢ëÊí≠Êîæ ‚Ä¢ 100ÈóÆÊµãËØï</p>
        </div>

        <div class="progress-container">
            <div class="progress-info">
                <span id="progressText">Question 1 / 50</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Stage 1: First Test (Questions 1-50) -->
        <div class="stage active" id="stage1">
            <div class="question-card">
                <div class="question-number" id="questionNumber">
                    Question 1 / 50
                </div>
                <div class="audio-controls">
                    <button class="play-button" id="playButton" onclick="playAudio()">
                        üîä Auto-play in <span id="countdown">1</span>s
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        * If audio doesn't auto-play, please click the button
                    </p>
                </div>
                <div class="sentence-display" id="sentenceDisplay">
                    Loading question...
                </div>
                <div class="error-message" id="errorMessage">
                    Please fill in the blank before proceeding.
                </div>
                <div class="button-group">
                    <button class="next-button" onclick="nextQuestion()">Next Question ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Stage 2: Answer Review (Mouse tracking) -->
        <div class="stage" id="stage2">
            <div class="feedback-section">
                <h2>üìù Answer Review - Spell Check</h2>
                <div class="mouse-tracking-info">
                    <strong>Ê≥®ÊÑèÔºö</strong> Âú®Ê≠§È°µÈù¢‰∏äÔºåÊàë‰ª¨Â∞ÜËÆ∞ÂΩïÊÇ®ÁöÑÈº†Ê†áÁÇπÂáªÂíåÈ°µÈù¢‰∫§‰∫íË°å‰∏∫Ôºå
                    Áî®‰∫éÁ†îÁ©∂Áî®Êà∑ÁïåÈù¢ÁöÑ‰ΩøÁî®Ê®°Âºè„ÄÇËøô‰∫õÊï∞ÊçÆ‰ªÖÁî®‰∫éÂ≠¶ÊúØÁ†îÁ©∂ÁõÆÁöÑ„ÄÇ
                </div>
                <p><strong>Âé≥Ê†ºÂà§ÂÆö:</strong> ÂÆåÂÖ®‰∏ÄËá¥„ÅÆ„ÅøÊ≠£Ëß£ | <strong>„Çπ„Éö„É´„ÉÅ„Çß„ÉÉ„ÇØ:</strong> Ëµ§„ÅÑÊ≥¢Á∑ö„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ê≠£Ëß£„ÇíÁ¢∫Ë™ç</p>
                <div id="answersReview"></div>
                <div class="button-group">
                    <button class="next-button" onclick="goToStage3()">Continue to Phase 2 ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Stage 3: Second Test (Questions 51-100) -->
        <div class="stage" id="stage3">
            <div class="question-card">
                <div class="question-number" id="questionNumber2">
                    Question 51 / 100
                </div>
                <div class="audio-controls">
                    <button class="play-button" id="playButton2" onclick="playAudio2()">
                        üîä Auto-play in <span id="countdown2">1</span>s
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        * If audio doesn't auto-play, please click the button
                    </p>
                </div>
                <div class="sentence-display" id="sentenceDisplay2">
                    Loading question...
                </div>
                <div class="error-message" id="errorMessage2">
                    Please fill in the blank before proceeding.
                </div>
                <div class="button-group">
                    <button class="next-button" onclick="nextQuestion2()">Next Question ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Stage 4: Survey -->
        <div class="stage" id="stage4">
            <div class="survey-section">
                <h2>üìã Post-Experiment Survey</h2>
                <p class="info-text">Thank you for completing the experiment!</p>
                
                <div class="survey-question">
                    <label>1. How difficult did you find this experiment?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="very_easy"> Very Easy
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="easy"> Easy
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="medium"> Medium
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="hard"> Hard
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="very_hard"> Very Hard
                        </label>
                    </div>
                </div>

                <div class="survey-question">
                    <label>2. How was the auto-play audio feature?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="excellent"> Excellent
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="good"> Good
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="fair"> Fair
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="poor"> Poor
                        </label>
                    </div>
                </div>

                <div class="survey-question">
                    <label>3. Did the strict answer matching system work well?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="very_helpful"> Very Helpful
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="helpful"> Helpful
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="neutral"> Neutral
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="not_helpful"> Not Helpful
                        </label>
                    </div>
                </div>

                <div class="survey-question">
                    <label>4. Additional comments about the experiment:</label>
                    <textarea class="survey-input" rows="4" id="additionalComments" placeholder="Please share your feedback..."></textarea>
                </div>

                <div class="button-group">
                    <button class="submit-button" onclick="completeExperiment()">
                        <span class="loading-spinner" id="submitSpinner"></span>
                        Submit Final Results ‚úì
                    </button>
                </div>
            </div>
        </div>

        <!-- Stage 5: Completion -->
        <div class="stage" id="stage5">
            <div class="completion-message">
                <h2>üéâ Experiment Complete!</h2>
                <p>Thank you for participating in our experiment!</p>
                <div id="finalResults"></div>
            </div>
        </div>
    </div>

    <script>
        // ============ FirebaseÈÖçÁΩÆ - ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑÂÆûÈôÖÈÖçÁΩÆ ============
        const firebaseConfig = {
            // üî• ËØ∑Âú®ËøôÈáåÂ°´ÂÖ•ÊÇ®‰ªéFirebase ConsoleËé∑ÂèñÁöÑÈÖçÁΩÆ‰ø°ÊÅØÔºÅ
            apiKey: "ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑAPI-KEY",
            authDomain: "ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑAUTH-DOMAIN",
            projectId: "ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑPROJECT-ID",
            storageBucket: "ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑSTORAGE-BUCKET", 
            messagingSenderId: "ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑMESSAGING-SENDER-ID",
            appId: "ËØ∑ÊõøÊç¢‰∏∫ÊÇ®ÁöÑAPP-ID"
        };

        // Ê£ÄÊü•FirebaseÈÖçÁΩÆÊòØÂê¶Â∑≤Êõ¥Êñ∞
        function checkFirebaseConfig() {
            const isConfigured = !firebaseConfig.apiKey.includes('ËØ∑ÊõøÊç¢');
            const statusElement = document.getElementById('firebaseStatus');
            
            if (!isConfigured) {
                statusElement.textContent = '‚ùå ËØ∑ÂÖàÈÖçÁΩÆFirebase‰ø°ÊÅØ';
                statusElement.className = 'firebase-status';
                console.error('üî• FirebaseÈÖçÁΩÆÊú™ÂÆåÊàêÔºÅËØ∑ÊåâÁÖßÊåáÂçóÈÖçÁΩÆFirebase‰ø°ÊÅØ„ÄÇ');
                return false;
            }
            
            return true;
        }

        // FirebaseÂàùÂßãÂåñ
        let db = null;
        let firebaseInitialized = false;

        async function initializeFirebase() {
            if (!checkFirebaseConfig()) {
                return false;
            }

            try {
                document.getElementById('firebaseStatus').textContent = 'üîÑ ËøûÊé•Firebase‰∏≠...';
                document.getElementById('firebaseStatus').className = 'firebase-status connecting';
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // ÊµãËØïËøûÊé•
                await db.collection('test').get();
                
                document.getElementById('firebaseStatus').textContent = '‚úÖ FirebaseÂ∑≤ËøûÊé•';
                document.getElementById('firebaseStatus').className = 'firebase-status connected';
                
                firebaseInitialized = true;
                console.log('üî• FirebaseÂàùÂßãÂåñÊàêÂäüÔºÅ');
                return true;
            } catch (error) {
                document.getElementById('firebaseStatus').textContent = '‚ùå FirebaseËøûÊé•Â§±Ë¥•';
                document.getElementById('firebaseStatus').className = 'firebase-status';
                console.error('‚ùå FirebaseÂàùÂßãÂåñÂ§±Ë¥•:', error);
                return false;
            }
        }

        // ============ ÂÖ®Â±ÄÂèòÈáè ============
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let currentPhase = 'phase1';
        let isReviewPhase = false;
        let mouseClickData = [];
        
        // ÂéüÊúâÂÆûÈ™åÊï∞ÊçÆÁªìÊûÑ
        let experimentData = {
            participantId: 'P' + Date.now(),
            prolificPID: null,
            round1Answers: [],
            round2Answers: [],
            reviewPhaseClicks: [],
            spellCheckClicks: 0,
            timestamps: { start: Date.now() }
        };

        // 50‰∏™ÈóÆÈ¢òÊï∞ÊçÆ
        const audioQuestions = [
            { sentence: "The government has ____ that the new tax policy has been a disaster.", answer: "conceded", audio: "audio/concede.mp3" },
            { sentence: "He's got a lot of ____ degrees and awards from educational establishments worldwide.", answer: "honorary", audio: "audio/honorary.mp3" },
            { sentence: "As people ____ more wealth, they tend to spend a greater proportion of their incomes.", answer: "accumulate", audio: "audio/accumulate.mp3" },
            { sentence: "Plant growth is most ____ in spring and early summer.", answer: "noticeable", audio: "audio/noticeable.mp3" },
            { sentence: "The ____ is to perform its last ever concert tomorrow night at the Albert Hall.", answer: "orchestra", audio: "audio/orchestra.mp3" },
            { sentence: "Public ____ about the disease is still a cause for concern.", answer: "ignorance", audio: "audio/ignorance.mp3" },
            { sentence: "The president does not want to answer any ____ questions.", answer: "theoretical", audio: "audio/theoretical.mp3" },
            { sentence: "Education should be ____ to the child's needs.", answer: "relevant", audio: "audio/relevant.mp3" },
            { sentence: "His father is buried in the ____ on the hill.", answer: "cemetery", audio: "audio/cemetery.mp3" },
            { sentence: "Although the play was written hundreds of years ago, it still has a ____ feel to it.", answer: "contemporary", audio: "audio/contemporary.mp3" },
            { sentence: "He is blessed with both good looks and ____.", answer: "intelligence", audio: "audio/intelligence.mp3" },
            { sentence: "He was brought up on a diet of political ____ from birth.", answer: "propaganda", audio: "audio/propaganda.mp3" },
            { sentence: "This recipe should be ____ for five people.", answer: "sufficient", audio: "audio/sufficient.mp3" },
            { sentence: "Young people don't always appreciate the ____ offered by their parents and teachers.", answer: "guidance", audio: "audio/guidance.mp3" },
            { sentence: "Not making a will can have serious ____ for your children and other family members.", answer: "consequences", audio: "audio/consequence.mp3" },
            { sentence: "The country is run on socialist ____.", answer: "principles", audio: "audio/principle.mp3" },
            { sentence: "Any help you could give me would be greatly ____.", answer: "appreciated", audio: "audio/appreciate.mp3" },
            { sentence: "He was arrested for taking part in ____ activities.", answer: "revolutionary", audio: "audio/revolutionary.mp3" },
            { sentence: "I think it helps if you have an ____ personality.", answer: "extroverted", audio: "audio/extrovert.mp3" },
            { sentence: "With the extra resources, the project now seems ____.", answer: "feasible", audio: "audio/feasible.mp3" },
            { sentence: "That party was too ____ for me!", answer: "bizarre", audio: "audio/bizarre.mp3" },
            { sentence: "The finance ____ controls the school's budget.", answer: "committee", audio: "audio/committee.mp3" },
            { sentence: "I like the ____ of living close to work.", answer: "convenience", audio: "audio/convenience.mp3" },
            { sentence: "It was when we started living together that we found we just weren't ____.", answer: "compatible", audio: "audio/compatible.mp3" },
            { sentence: "He told the ____ story of his escape.", answer: "extraordinary", audio: "audio/extraordinary.mp3" },
            { sentence: "He told one or two ____ stories about his years as a policeman.", answer: "humorous", audio: "audio/humorous.mp3" },
            { sentence: "We really ought to leave ____.", answer: "immediately", audio: "audio/immediately.mp3" },
            { sentence: "An ____ inquiry will determine whether the case should move forward.", answer: "independent", audio: "audio/independent.mp3" },
            { sentence: "He decided to ____ a career in television.", answer: "pursue", audio: "audio/pursue.mp3" },
            { sentence: "She has shown herself to be a highly ____ manager.", answer: "competent", audio: "audio/competent.mp3" },
            { sentence: "The children have no ____ of being different.", answer: "consciousness", audio: "audio/consciousness.mp3" },
            { sentence: "An old ____ for 2012 was still hanging on the wall of her office.", answer: "calendar", audio: "audio/calendar.mp3" },
            { sentence: "The general ____ in the office is that he can't do his job.", answer: "consensus", audio: "audio/consensus.mp3" },
            { sentence: "The sun ____ behind heavy clouds.", answer: "disappeared", audio: "audio/disappear.mp3" },
            { sentence: "I'm sorry to ____ you, but I'm afraid I can't come after all.", answer: "disappoint", audio: "audio/disappoint.mp3" },
            { sentence: "Such a war would be ____ for the country.", answer: "disastrous", audio: "audio/disastrous.mp3" },
            { sentence: "Some monkeys have a very complex social ____.", answer: "hierarchy", audio: "audio/hierarchy.mp3" },
            { sentence: "We met on several ____ to discuss the issue.", answer: "occasions", audio: "audio/occasion.mp3" },
            { sentence: "I had the ____ of interviewing Picasso in the 1960s.", answer: "privilege", audio: "audio/privilege.mp3" },
            { sentence: "Store fruit juice in the ____.", answer: "refrigerator", audio: "audio/refrigerator.mp3" },
            { sentence: "I didn't want to ____ her in front of her friends.", answer: "embarrass", audio: "audio/embarrass.mp3" },
            { sentence: "The art department and the music department are in two ____ buildings.", answer: "separate", audio: "audio/separate.mp3" },
            { sentence: "She ____ for her husband's rudeness.", answer: "apologized", audio: "audio/apologize.mp3" },
            { sentence: "I'll be living here for the ____ future.", answer: "foreseeable", audio: "audio/foreseeable.mp3" },
            { sentence: "She gave me one of those ____ smiles and I just had to agree.", answer: "irresistible", audio: "audio/irresistible.mp3" },
            { sentence: "Imagine what the world will be like at the end of the next ____.", answer: "millennium", audio: "audio/millennium.mp3" },
            { sentence: "There are two different ____ of this word.", answer: "pronunciations", audio: "audio/pronunciation.mp3" },
            { sentence: "Visitors to the country have been asked to fill out a detailed ____.", answer: "questionnaire", audio: "audio/questionnaire.mp3" },
            { sentence: "He ____ said he'd be here.", answer: "definitely", audio: "audio/definitely.mp3" },
            { sentence: "Death was an everyday ____ during the Civil War.", answer: "occurrence", audio: "audio/occurrence.mp3" }
        ];

        let currentQuestionIndex = 0;
        let countdownTimer = null;
        let currentAudio = null;

        // ============ FirebaseÊï∞ÊçÆËÆ∞ÂΩïÂáΩÊï∞ ============
        async function initializeExperiment() {
            if (!firebaseInitialized) {
                console.log('‚ö†Ô∏è FirebaseÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáÊï∞ÊçÆËÆ∞ÂΩï');
                return;
            }

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const prolificId = urlParams.get('PROLIFIC_PID') || 'test_user_' + Date.now();
                
                experimentData.prolificPID = prolificId;
                
                await db.collection('audio_experiment_sessions').doc(sessionId).set({
                    participantId: experimentData.participantId,
                    prolificId: prolificId,
                    startTime: firebase.firestore.Timestamp.now(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    phase1_completed: false,
                    phase2_completed: false,
                    experiment_completed: false,
                    created_at: firebase.firestore.Timestamp.now()
                });
                
                console.log('üî• ÂÆûÈ™å‰ºöËØùÂ∑≤ÂàõÂª∫, Session ID:', sessionId);
            } catch (error) {
                console.error('‚ùå ÂàõÂª∫ÂÆûÈ™å‰ºöËØùÂ§±Ë¥•:', error);
            }
        }

        async function recordPhase1Answer(questionNumber, audioFile, userAnswer, correctAnswer, responseTime) {
            if (!firebaseInitialized) return;
            
            try {
                const answerData = {
                    sessionId: sessionId,
                    phase: 'phase1',
                    questionNumber: questionNumber,
                    audioFile: audioFile,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim(),
                    responseTime: responseTime,
                    timestamp: firebase.firestore.Timestamp.now()
                };
                
                await db.collection('phase1_answers').add(answerData);
                console.log(`üìù Èò∂ÊÆµ1 ÈóÆÈ¢ò${questionNumber} Â∑≤ËÆ∞ÂΩï`);
                
                if (questionNumber === 50) {
                    await db.collection('audio_experiment_sessions').doc(sessionId).update({
                        phase1_completed: true,
                        phase1_completion_time: firebase.firestore.Timestamp.now()
                    });
                }
            } catch (error) {
                console.error('‚ùå ËÆ∞ÂΩïÈò∂ÊÆµ1Á≠îÊ°àÂ§±Ë¥•:', error);
            }
        }

        async function recordPhase2Answer(questionNumber, audioFile, userAnswer, correctAnswer, responseTime) {
            if (!firebaseInitialized) return;
            
            try {
                const answerData = {
                    sessionId: sessionId,
                    phase: 'phase2',
                    questionNumber: questionNumber + 50, // 51-100
                    audioFile: audioFile,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim(),
                    responseTime: responseTime,
                    timestamp: firebase.firestore.Timestamp.now()
                };
                
                await db.collection('phase2_answers').add(answerData);
                console.log(`üìù Èò∂ÊÆµ2 ÈóÆÈ¢ò${questionNumber + 50} Â∑≤ËÆ∞ÂΩï`);
                
                if (questionNumber === 49) { // Á¨¨‰∫åËΩÆÁöÑÁ¨¨50È¢ò
                    await db.collection('audio_experiment_sessions').doc(sessionId).update({
                        phase2_completed: true,
                        phase2_completion_time: firebase.firestore.Timestamp.now(),
                        experiment_completed: true,
                        total_completion_time: firebase.firestore.Timestamp.now()
                    });
                }
            } catch (error) {
                console.error('‚ùå ËÆ∞ÂΩïÈò∂ÊÆµ2Á≠îÊ°àÂ§±Ë¥•:', error);
            }
        }

        // ============ Èº†Ê†áËøΩË∏™ÂáΩÊï∞ ============
        function startMouseTracking() {
            isReviewPhase = true;
            mouseClickData = [];
            console.log('üñ±Ô∏è ÂºÄÂßãËøΩË∏™ReviewÈò∂ÊÆµÈº†Ê†áÁÇπÂáª');
            
            document.addEventListener('click', recordMouseClick);
            document.addEventListener('scroll', recordScrollEvent);
            document.addEventListener('keypress', recordKeyPress);
        }

        function recordMouseClick(event) {
            if (!isReviewPhase) return;
            
            const clickData = {
                type: 'click',
                timestamp: Date.now(),
                x: event.clientX,
                y: event.clientY,
                pageX: event.pageX,
                pageY: event.pageY,
                target: {
                    tagName: event.target.tagName,
                    id: event.target.id,
                    className: event.target.className,
                    textContent: event.target.textContent?.substring(0, 100)
                },
                button: event.button,
                ctrlKey: event.ctrlKey,
                shiftKey: event.shiftKey,
                altKey: event.altKey
            };
            
            mouseClickData.push(clickData);
            experimentData.reviewPhaseClicks.push(clickData);
        }

        function recordScrollEvent(event) {
            if (!isReviewPhase) return;
            
            const scrollData = {
                type: 'scroll',
                timestamp: Date.now(),
                scrollX: window.scrollX,
                scrollY: window.scrollY
            };
            
            mouseClickData.push(scrollData);
        }

        function recordKeyPress(event) {
            if (!isReviewPhase) return;
            
            const keyData = {
                type: 'keypress',
                timestamp: Date.now(),
                key: event.key,
                code: event.code
            };
            
            mouseClickData.push(keyData);
        }

        async function saveMouseTrackingData() {
            if (!firebaseInitialized || mouseClickData.length === 0) return;
            
            try {
                const trackingData = {
                    sessionId: sessionId,
                    phase: 'confirmation_page',
                    totalClicks: mouseClickData.filter(d => d.type === 'click').length,
                    totalScrolls: mouseClickData.filter(d => d.type === 'scroll').length,
                    totalKeyPresses: mouseClickData.filter(d => d.type === 'keypress').length,
                    timeSpentOnPage: mouseClickData.length > 0 ? 
                        mouseClickData[mouseClickData.length - 1].timestamp - mouseClickData[0].timestamp : 0,
                    clickEvents: mouseClickData,
                    timestamp: firebase.firestore.Timestamp.now()
                };
                
                await db.collection('confirmation_page_interactions').add(trackingData);
                console.log('üñ±Ô∏è ReviewÈò∂ÊÆµ‰∫§‰∫íÊï∞ÊçÆÂ∑≤‰øùÂ≠ò');
                
                // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
                document.removeEventListener('click', recordMouseClick);
                document.removeEventListener('scroll', recordScrollEvent);
                document.removeEventListener('keypress', recordKeyPress);
                
                isReviewPhase = false;
                mouseClickData = [];
            } catch (error) {
                console.error('‚ùå ‰øùÂ≠òÈº†Ê†áËøΩË∏™Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // ============ ÂéüÊúâÂÆûÈ™åÈÄªËæë ============
        function initializeProlificData() {
            const urlParams = new URLSearchParams(window.location.search);
            experimentData.prolificPID = urlParams.get('PROLIFIC_PID') || 'TEST_USER';
        }

        function trackReviewClick(type, data) {
            experimentData.reviewPhaseClicks.push({
                type: type,
                data: data,
                timestamp: Date.now(),
                coordinates: { x: event.clientX, y: event.clientY }
            });
        }

        function sendDataToServer(type, data) {
            console.log('üì§ Sending data:', type, data);
        }

        function strictAnswerCheck(userAnswer, correctAnswer) {
            return userAnswer.trim() === correctAnswer.trim();
        }

        function calculateAccuracy(answers) {
            if (answers.length === 0) return 0;
            const correct = answers.filter(answer => 
                strictAnswerCheck(answer.userAnswer, answer.correctAnswer)
            ).length;
            return Math.round((correct / answers.length) * 100);
        }

        function startCountdown(buttonId, countdownId) {
            const button = document.getElementById(buttonId);
            const countdownElement = document.getElementById(countdownId);
            
            if (!button || !countdownElement) return;
            
            let timeLeft = 1;
            countdownElement.textContent = timeLeft;
            
            if (countdownTimer) clearInterval(countdownTimer);
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    playRealAudio(buttonId);
                }
            }, 1000);
        }

        // È°µÈù¢Ë∑≥ËΩ¨ÂêéËá™Âä®ÂºÄÂßãÂÄíËÆ°Êó∂ÂíåÈü≥È¢ëÊí≠Êîæ
        function autoStartAudio() {
            setTimeout(() => {
                const activeStage = document.querySelector('.stage.active');
                if (!activeStage) return;
                
                if (activeStage.id === 'stage1') {
                    startCountdown('playButton', 'countdown');
                } else if (activeStage.id === 'stage3') {
                    startCountdown('playButton2', 'countdown2');
                }
            }, 500); // Â¢ûÂä†Âª∂ËøüÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩ
        }

        // Âº∫Âà∂Ëá™Âä®Êí≠Êîæ - Êñ∞Â¢ûÂäüËÉΩ
        function forceAutoPlay() {
            const activeStage = document.querySelector('.stage.active');
            if (!activeStage) return;
            
            let buttonId, countdownId;
            if (activeStage.id === 'stage1') {
                buttonId = 'playButton';
                countdownId = 'countdown';
            } else if (activeStage.id === 'stage3') {
                buttonId = 'playButton2';
                countdownId = 'countdown2';
            } else {
                return;
            }
            
            const button = document.getElementById(buttonId);
            const countdownElement = document.getElementById(countdownId);
            
            if (!button || !countdownElement) return;
            
            // Ê∏ÖÈô§Áé∞ÊúâËÆ°Êó∂Âô®
            if (countdownTimer) clearInterval(countdownTimer);
            
            // Á´ãÂç≥ÂºÄÂßãÂÄíËÆ°Êó∂
            let timeLeft = 1;
            countdownElement.textContent = timeLeft;
            button.textContent = `üîä Auto-play in ${timeLeft}s`;
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                button.textContent = `üîä Auto-play in ${timeLeft}s`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    playRealAudio(buttonId);
                }
            }, 1000);
        }

        function playRealAudio(buttonId) {
            const button = document.getElementById(buttonId);
            const question = audioQuestions[currentQuestionIndex];
            
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            
            button.textContent = 'üîä Playing Audio...';
            button.disabled = true;
            
            currentAudio = new Audio(question.audio);
            currentAudio.preload = 'auto';
            currentAudio.volume = 0.8;
            
            currentAudio.addEventListener('loadeddata', () => {
                const playPromise = currentAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Audio playing successfully');
                    }).catch(error => {
                        console.log('Autoplay blocked, user interaction required:', error);
                        button.textContent = 'üîä Click to Play Audio';
                        button.disabled = false;
                        
                        button.onclick = function() {
                            currentAudio.play();
                            button.textContent = 'üîä Playing Audio...';
                            button.disabled = true;
                        };
                    });
                }
            });
            
            currentAudio.addEventListener('ended', () => {
                button.textContent = 'üîä Play Again';
                button.disabled = false;
                
                if (buttonId === 'playButton') {
                    button.onclick = playAudio;
                } else {
                    button.onclick = playAudio2;
                }
                
                const activeStage = document.querySelector('.stage.active');
                if (activeStage) {
                    if (activeStage.id === 'stage1') {
                        const input = document.getElementById('answerInput');
                        if (input) input.focus();
                    } else if (activeStage.id === 'stage3') {
                        const input = document.getElementById('answerInput2');
                        if (input) input.focus();
                    }
                }
            });
            
            currentAudio.addEventListener('error', (e) => {
                console.error('Audio loading error:', e);
                button.textContent = 'üîä Audio Error - Click to Retry';
                button.disabled = false;
                
                button.onclick = function() {
                    playRealAudio(buttonId);
                };
            });
        }

        function initializeQuestion() {
            if (currentQuestionIndex < audioQuestions.length) {
                const question = audioQuestions[currentQuestionIndex];
                const sentenceWithBlank = question.sentence.replace('____', 
                    '<input type="text" class="input-field" id="answerInput" placeholder="____" autocomplete="off">');
                
                document.getElementById('sentenceDisplay').innerHTML = sentenceWithBlank;
                document.getElementById('questionNumber').textContent = 
                    `Question ${currentQuestionIndex + 1} / ${audioQuestions.length}`;
                
                const progress = (currentQuestionIndex / audioQuestions.length) * 50;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `Question ${currentQuestionIndex + 1} / ${audioQuestions.length}`;
                
                document.getElementById('errorMessage').style.display = 'none';
                
                // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                setTimeout(() => {
                    const input = document.getElementById('answerInput');
                    if (input) input.focus();
                }, 100);
                
                // Âº∫Âà∂Ëá™Âä®Êí≠ÊîæÈü≥È¢ë - Â¢ûÂº∫Áâà
                setTimeout(() => {
                    forceAutoPlay();
                }, 800);
            }
        }

        function initializeQuestion2() {
            if (currentQuestionIndex < audioQuestions.length) {
                const question = audioQuestions[currentQuestionIndex];
                const sentenceWithBlank = question.sentence.replace('____', 
                    '<input type="text" class="input-field" id="answerInput2" placeholder="____" autocomplete="off">');
                
                document.getElementById('sentenceDisplay2').innerHTML = sentenceWithBlank;
                document.getElementById('questionNumber2').textContent = 
                    `Question ${currentQuestionIndex + 51} / 100`;
                
                const progress = 50 + (currentQuestionIndex / audioQuestions.length) * 50;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `Question ${currentQuestionIndex + 51} / 100`;
                
                document.getElementById('errorMessage2').style.display = 'none';
                
                // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                setTimeout(() => {
                    const input = document.getElementById('answerInput2');
                    if (input) input.focus();
                }, 100);
                
                // Âº∫Âà∂Ëá™Âä®Êí≠ÊîæÈü≥È¢ë - Â¢ûÂº∫Áâà
                setTimeout(() => {
                    forceAutoPlay();
                }, 800);
            }
        }

        function playAudio() {
            if (countdownTimer) clearInterval(countdownTimer);
            playRealAudio('playButton');
        }

        function playAudio2() {
            if (countdownTimer) clearInterval(countdownTimer);
            playRealAudio('playButton2');
        }

        function nextQuestion() {
            const input = document.getElementById('answerInput');
            const answer = input ? input.value.trim() : '';
            
            if (!answer) {
                document.getElementById('errorMessage').style.display = 'block';
                if (input) input.focus();
                return;
            }
            
            const correctAnswer = audioQuestions[currentQuestionIndex].answer;
            const isCorrect = strictAnswerCheck(answer, correctAnswer);
            const responseTime = Date.now() - experimentData.timestamps.start;
            
            experimentData.round1Answers.push({
                questionIndex: currentQuestionIndex,
                userAnswer: answer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: Date.now()
            });
            
            // FirebaseËÆ∞ÂΩï
            recordPhase1Answer(
                currentQuestionIndex + 1, 
                audioQuestions[currentQuestionIndex].audio,
                answer,
                correctAnswer,
                responseTime
            );
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= audioQuestions.length) {
                goToStage2();
            } else {
                initializeQuestion();
            }
        }

        function nextQuestion2() {
            const input = document.getElementById('answerInput2');
            const answer = input ? input.value.trim() : '';
            
            if (!answer) {
                document.getElementById('errorMessage2').style.display = 'block';
                if (input) input.focus();
                return;
            }
            
            const correctAnswer = audioQuestions[currentQuestionIndex].answer;
            const isCorrect = strictAnswerCheck(answer, correctAnswer);
            const responseTime = Date.now() - experimentData.timestamps.start;
            
            experimentData.round2Answers.push({
                questionIndex: currentQuestionIndex,
                userAnswer: answer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: Date.now()
            });
            
            // FirebaseËÆ∞ÂΩï
            recordPhase2Answer(
                currentQuestionIndex,
                audioQuestions[currentQuestionIndex].audio,
                answer,
                correctAnswer,
                responseTime
            );
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= audioQuestions.length) {
                goToStage4();
            } else {
                initializeQuestion2();
            }
        }

        function goToStage2() {
            document.getElementById('stage1').classList.remove('active');
            document.getElementById('stage2').classList.add('active');
            
            document.getElementById('progressFill').style.width = '50%';
            document.getElementById('progressText').textContent = 'Review Phase';
            
            startMouseTracking();
            generateAnswerReview();
        }

        function generateAnswerReview() {
            const reviewContainer = document.getElementById('answersReview');
            let reviewHTML = '<div style="line-height: 2.5; font-size: 1.2em;">';
            
            experimentData.round1Answers.forEach((item, index) => {
                const questionText = audioQuestions[item.questionIndex].sentence;
                
                if (item.isCorrect) {
                    const filledSentence = questionText.replace('____', 
                        `<strong style="color: #333; background: rgba(0, 0, 0, 0.05); padding: 2px 6px; border-radius: 4px;">${item.userAnswer}</strong>`);
                    reviewHTML += `<p>${index + 1}. ${filledSentence}</p>`;
                } else {
                    const filledSentence = questionText.replace('____', 
                        `<span class="spell-error-text" onclick="showCorrection(${index}, '${item.correctAnswer}', '${item.userAnswer}')">${item.userAnswer}</span>`);
                    reviewHTML += `<p>${index + 1}. ${filledSentence}</p>`;
                }
            });
            
            reviewHTML += '</div>';
            reviewContainer.innerHTML = reviewHTML;
        }

        function showCorrection(index, correctAnswer, userAnswer) {
            trackReviewClick('spell_check_click', { 
                questionIndex: index, 
                userAnswer: userAnswer, 
                correctAnswer: correctAnswer 
            });
            
            const existingPopups = document.querySelectorAll('.word-correction-popup');
            existingPopups.forEach(popup => popup.remove());
            
            const popup = document.createElement('div');
            popup.className = 'word-correction-popup';
            popup.innerHTML = `<div class="correction-option">${correctAnswer}</div>`;
            
            const errorElement = event.target;
            const rect = errorElement.getBoundingClientRect();
            popup.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
            popup.style.top = (rect.bottom + 5) + 'px';
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 3000);
            
            experimentData.spellCheckClicks++;
        }

        async function goToStage3() {
            await saveMouseTrackingData();
            
            document.getElementById('stage2').classList.remove('active');
            document.getElementById('stage3').classList.add('active');
            
            currentQuestionIndex = 0;
            currentPhase = 'phase2';
            
            document.getElementById('progressText').textContent = 'Starting Phase 2...';
            
            // Á°Æ‰øùÂú®È°µÈù¢ÂàáÊç¢ÂêéÁ´ãÂç≥ÂºÄÂßãÈü≥È¢ëÊí≠Êîæ
            setTimeout(() => {
                initializeQuestion2();
            }, 100);
        }

        function goToStage4() {
            document.getElementById('stage3').classList.remove('active');
            document.getElementById('stage4').classList.add('active');
            
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = 'Survey Phase';
        }

        async function completeExperiment() {
            const spinner = document.getElementById('submitSpinner');
            const button = event.target;
            
            spinner.style.display = 'inline-block';
            button.disabled = true;
            
            const surveyData = {};
            
            ['difficulty', 'audio_feature', 'strict_matching'].forEach(name => {
                const radio = document.querySelector(`input[name="${name}"]:checked`);
                if (radio) {
                    surveyData[name] = radio.value;
                }
            });
            
            surveyData.additionalComments = document.getElementById('additionalComments').value;
            experimentData.surveyResponses = surveyData;
            experimentData.timestamps.experimentComplete = Date.now();
            
            const completionCode = generateCompletionCode();
            
            // Firebase‰øùÂ≠òË∞ÉÊü•Êï∞ÊçÆ
            if (firebaseInitialized) {
                try {
                    await db.collection('survey_responses').add({
                        sessionId: sessionId,
                        surveyData: surveyData,
                        completionCode: completionCode,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('üìã Ë∞ÉÊü•Êï∞ÊçÆÂ∑≤‰øùÂ≠ò');
                } catch (error) {
                    console.error('‚ùå ‰øùÂ≠òË∞ÉÊü•Êï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
            
            setTimeout(() => {
                spinner.style.display = 'none';
                button.disabled = false;
                
                document.getElementById('stage4').classList.remove('active');
                document.getElementById('stage5').classList.add('active');
                
                displayFinalResults(completionCode);
            }, 2000);
        }

        function generateCompletionCode() {
            return 'EXP' + Date.now().toString().slice(-6);
        }

        function displayFinalResults(completionCode) {
            const resultsContainer = document.getElementById('finalResults');
            
            const round1Accuracy = calculateAccuracy(experimentData.round1Answers);
            const round2Accuracy = calculateAccuracy(experimentData.round2Answers);
            const overallAccuracy = Math.round(((experimentData.round1Answers.filter(a => a.isCorrect).length + 
                                               experimentData.round2Answers.filter(a => a.isCorrect).length) / 
                                               (experimentData.round1Answers.length + experimentData.round2Answers.length)) * 100);
            
            resultsContainer.innerHTML = `
                <div class="stats-display">
                    <div class="stat-card">
                        <div class="stat-number">${round1Accuracy}%</div>
                        <div>Phase 1 Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${round2Accuracy}%</div>
                        <div>Phase 2 Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${overallAccuracy}%</div>
                        <div>Overall Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">100</div>
                        <div>Total Questions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${experimentData.spellCheckClicks}</div>
                        <div>Spell Checks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${experimentData.reviewPhaseClicks.length}</div>
                        <div>Review Clicks</div>
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; margin-top: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 1.4em;">üéØ Completion Code for Prolific:</h3>
                    <div style="background: rgba(255,255,255,0.9); color: #333; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 1.5em; font-weight: bold; text-align: center; letter-spacing: 2px;">
                        ${completionCode}
                    </div>
                    <p style="margin-top: 15px; font-size: 1.1em;">
                        Please copy this code and paste it into Prolific to receive your payment.
                    </p>
                </div>
                
                <p style="margin-top: 25px; font-size: 1.1em;">
                    <strong>Participant ID:</strong> ${experimentData.participantId}<br>
                    <strong>Session ID:</strong> ${sessionId}<br>
                    <strong>Firebase Status:</strong> ${firebaseInitialized ? '‚úÖ Connected' : '‚ùå Not Connected'}
                </p>
            `;
        }

        // ÈîÆÁõòÂØºËà™
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeStage = document.querySelector('.stage.active');
                if (activeStage) {
                    const stageId = activeStage.id;
                    
                    if (stageId === 'stage1') {
                        const input = document.getElementById('answerInput');
                        if (input && document.activeElement === input) {
                            nextQuestion();
                        }
                    } else if (stageId === 'stage3') {
                        const input = document.getElementById('answerInput2');
                        if (input && document.activeElement === input) {
                            nextQuestion2();
                        }
                    }
                }
            }
        });

        function enableAudio() {
            const silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAAAQQBEAEEAhAIBAQEAAQAAAQABAAABAAgABgAGAAYABgAGAA==');
            silentAudio.volume = 0;
            silentAudio.play().then(() => {
                console.log('Audio context enabled');
            }).catch(() => {
                console.log('Audio context failed to enable');
            });
        }

        // ============ ÂàùÂßãÂåñ ============
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéß Audio Listening Experiment v8.0 - Firebase Enhanced');
            
            // ÂàùÂßãÂåñFirebase
            const firebaseReady = await initializeFirebase();
            
            if (firebaseReady) {
                console.log('‚úÖ FirebaseÂ∑≤Â∞±Áª™ÔºåÂºÄÂßãËÆ∞ÂΩïÊï∞ÊçÆ');
                await initializeExperiment();
            } else {
                console.log('‚ö†Ô∏è FirebaseÊú™Â∞±Áª™ÔºåÂÆûÈ™åÂ∞ÜÂú®Êó†Êï∞ÊçÆËÆ∞ÂΩïÊ®°Âºè‰∏ãËøêË°å');
            }
            
            initializeProlificData();
            
            // ÂêØÁî®Èü≥È¢ë‰∏ä‰∏ãÊñáÔºàÁî®Êà∑‰∫§‰∫íÂêéÔºâ
            document.addEventListener('click', enableAudio, { once: true });
            document.addEventListener('keydown', enableAudio, { once: true });
            
            // ÂàùÂßãÂåñÁ¨¨‰∏Ä‰∏™ÈóÆÈ¢òÂπ∂Ëá™Âä®Êí≠Êîæ
            setTimeout(() => {
                initializeQuestion();
            }, 500);
        });

        // È°µÈù¢Á¶ªÂºÄÊó∂Ê∏ÖÁêÜ
        window.addEventListener('beforeunload', function() {
            if (countdownTimer) clearInterval(countdownTimer);
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
        });
    </script>
</body>
</html>
