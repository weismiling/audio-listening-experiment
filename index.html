<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Listening Experiment </title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 900px;
            width: 90%;
            margin: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 35px;
        }

        .header h1 {
            color: #333;
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .version-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .firebase-status {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.85em;
            margin-top: 10px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .firebase-status.connected {
            background: #28a745;
        }

        .firebase-status.connecting {
            background: #ffc107;
            color: #333;
        }

        .stage {
            display: none;
        }

        .stage.active {
            display: block;
        }

        .progress-container {
            margin-bottom: 35px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e8ecf4;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.4s ease;
        }

        .question-card {
            background: #f8f9ff;
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .question-number {
            color: #667eea;
            font-weight: 700;
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .audio-controls {
            text-align: center;
            margin: 25px 0;
        }

        .play-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            min-width: 240px;
        }

        .play-button:hover {
            background: #5a6fd8;
        }

        .play-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sentence-display {
            font-size: 1.4em;
            margin: 30px 0;
            text-align: center;
            line-height: 2.2;
            padding: 25px;
            background: white;
            border-radius: 16px;
        }

        .input-field {
            border: none;
            border-bottom: 3px solid #667eea;
            background: white;
            font-size: 1.3em;
            padding: 12px 16px;
            margin: 0 10px;
            min-width: 200px;
            max-width: 250px;
            text-align: center;
            outline: none;
            border-radius: 8px 8px 0 0;
        }

        .spell-error-text {
            border-bottom: 3px wavy #e74c3c;
            background-color: rgba(231, 76, 60, 0.15);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            text-decoration: underline;
            text-decoration-color: #e74c3c;
            text-decoration-style: wavy;
            text-decoration-thickness: 2px;
            font-weight: 500;
        }

        .spell-error-text:hover {
            background-color: rgba(231, 76, 60, 0.25);
            text-decoration-thickness: 3px;
        }

        .word-correction-popup {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .correction-option {
            padding: 8px 12px;
            font-weight: 600;
            color: #28a745;
        }

        .next-button, .submit-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            margin: 25px 15px;
        }

        .next-button:hover, .submit-button:hover {
            background: #218838;
        }

        .feedback-section {
            background: #e8f5e8;
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #28a745;
        }

        .survey-section {
            background: #fff3cd;
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #ffc107;
        }

        .survey-question {
            margin: 25px 0;
        }

        .survey-question label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .survey-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .completion-message {
            text-align: center;
            padding: 50px;
            background: #28a745;
            color: white;
            border-radius: 24px;
        }

        .completion-message h2 {
            font-size: 3em;
            margin-bottom: 25px;
        }

        .button-group {
            text-align: center;
            margin-top: 25px;
        }

        .info-text {
            text-align: center;
            color: #666;
            margin: 25px 0;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .mouse-tracking-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        /* æ–°å¢ï¼šè°ƒæŸ¥é—®å·å¿…ç­”æç¤ºæ ·å¼ */
        .survey-error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            border-left: 4px solid #dc3545;
        }

        .required-question {
            border-left: 4px solid #dc3545;
            padding-left: 15px;
            background: rgba(220, 53, 69, 0.05);
            border-radius: 5px;
        }

        .stage-indicator {
            background: #667eea;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            display: inline-block;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .stage-indicator.review {
            background: #28a745;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .stage-indicator.survey {
            background: #ffc107;
            color: #333;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        /* ç§»é™¤ï¼šæ’­æ”¾ç»Ÿè®¡æ˜¾ç¤ºæ ·å¼ */

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ Audio Listening Experiment </h1>
            <div class="firebase-status connecting" id="firebaseStatus">ğŸ”„ Please configure Firebase first...</div>
            <p class="info-text"> </p>
        </div>

       

        <!-- Welcome Stage: Experiment Introduction -->
        <div class="stage active" id="welcomeStage">
            <div class="question-card">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">ğŸ§ Welcome to Audio Listening Experiment</h2>
                
                <div style="background: #e3f2fd; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #1976d2; margin-bottom: 20px;">ğŸ“‹ Experiment Instructions:</h3>
                    <ul style="line-height: 2; color: #333; font-size: 1.1em;">
                        <li><strong>Duration:</strong> Approximately 20-30 minutes</li>
                        <li><strong>Structure:</strong> 100 audio questions in 2 phases (50 each)</li>
                        <li><strong>Task:</strong> Listen to audio and fill in the missing word</li>
                        <li><strong>Audio:</strong> Each audio will auto-play after 1 second</li>
                        <li><strong>Review:</strong> After Phase 1, there is a review stage where you can check your mistakes. Misspelled words are underlined in red, and clicking on them shows the correct spelling.</li>
                        <li><strong>Requirements:</strong> Use headphones for best audio quality</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h4 style="color: #856404; margin-bottom: 15px;">âš ï¸ Important Notes:</h4>
                    <ul style="color: #856404; line-height: 1.8;">
                        <li>To confirm task completion and analyze participant behavior, this experiment <strong>records all mouse clicks and interactions</strong>. The data will be used solely for research purposes.</li>
                        <li>Please ensure you have a stable internet connection</li>
                        <li>Use headphones or speakers for clear audio</li>
                        <li>Complete the experiment in one session without refreshing</li>
                        <li>Your responses will be automatically saved</li>
                    </ul>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; font-size: 1.2em; color: #333; margin-bottom: 10px;">
                        ğŸ†” Please enter your Prolific ID:
                    </label>
                    <input type="text" id="prolificIdInput" placeholder="Enter your Prolific ID here..." 
                           style="width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: #666; font-size: 0.9em; margin: 0;">
                        This ID is provided by Prolific and is required to receive payment.
                    </p>
                </div>
                
                <div class="button-group" style="text-align: center;">
                    <button class="next-button" onclick="startExperiment()" id="startExperimentBtn" style="font-size: 1.3em; padding: 18px 40px;">
                         Start Experiment
                    </button>
                </div>
                
                <div class="error-message" id="welcomeErrorMessage">
                    Please enter your Prolific ID before starting the experiment.
                </div>
            </div>
        </div>

        <!-- Stage 1: First Test (Questions 1-50) -->
        <div class="stage" id="stage1">
            <div class="stage-indicator">ğŸ§ Phase 1</div>
           <div class="progress-container">
            <div class="progress-info">
                <span id="progressText"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            </div>
            
            <div class="question-card">
                <div class="question-number" id="questionNumber">
                    1 / 50
                </div>
                <div class="audio-controls">
                    <button class="play-button" id="playButton" onclick="playAudio()">
                        ğŸ”Š Auto-play in <span id="countdown">1</span>s
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        * If audio doesn't auto-play, please click the button
                    </p>
                </div>
                <div class="sentence-display" id="sentenceDisplay">
                    Loading question...
                </div>
                <div class="error-message" id="errorMessage">
                    Please fill in the blank before proceeding.
                </div>
                <div class="button-group">
                    <button class="next-button" onclick="nextQuestion()">Next Question â†’</button>
                </div>
            </div>
        </div>

        <!-- Stage 2: Answer Review (Mouse tracking) -->
        <div class="stage" id="stage2">
            <div class="stage-indicator review">ğŸ“ Review</div>
            <div class="feedback-section">
                <h2>ğŸ“ Answer Review </h2>
                <p><strong>Spell Check:</strong> Click red wavy lines to see correct answers</p>
                <div id="answersReview"></div>
                <div class="button-group">
                    <button class="next-button" onclick="goToStage3()">Continue to Phase 2 â†’</button>
                </div>
            </div>
        </div>

        <!-- Stage 3: Second Test (Questions 51-100) -->
        <div class="stage" id="stage3">
            <div class="stage-indicator">ğŸ§ Phase 2</div>
            <!-- ä¿®å¤é—®é¢˜1ï¼šä¸ºé˜¶æ®µ3æ·»åŠ è¿›åº¦æ¡ -->
            <div class="progress-container">
                <div class="progress-info">
                    <span id="progressText2"></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill2"></div>
                </div>
            </div>
            
            <div class="question-card">
                <div class="question-number" id="questionNumber2">
                    1 / 50
                </div>
                <div class="audio-controls">
                    <button class="play-button" id="playButton2" onclick="playAudio2()">
                        ğŸ”Š Auto-play in <span id="countdown2">1</span>s
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        * If audio doesn't auto-play, please click the button
                    </p>
                </div>
                <div class="sentence-display" id="sentenceDisplay2">
                    Loading question...
                </div>
                <div class="error-message" id="errorMessage2">
                    Please fill in the blank before proceeding.
                </div>
                <div class="button-group">
                    <button class="next-button" onclick="nextQuestion2()">Next Question â†’</button>
                </div>
            </div>
        </div>

        <!-- Stage 4: Survey -->
        <div class="stage" id="stage4">
            <div class="stage-indicator survey">ğŸ“Š Post-Experiment Survey</div>
            <div class="survey-section">
                <p class="info-text">Thank you for completing the experiment! Please share your feedback.</p>
                
                <!-- ä¿®å¤é—®é¢˜2ï¼šè°ƒæŸ¥é—®å·å¿…ç­”é”™è¯¯æç¤º -->
                <div class="survey-error" id="surveyErrorMessage">
                    Please answer all required questions before submitting.
                </div>
                
                <div class="survey-question required-question">
                    <label><strong>1. How difficult did you find this task? *</strong></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="very_difficult"> Very difficult
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="difficult"> Difficult
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="neutral"> Neutral
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="easy"> Easy
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="very_easy"> Very easy
                        </label>
                    </div>
                </div>

                <div class="survey-question required-question">
                    <label><strong>2. How confident are you in your answers to the previous questions? *</strong></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="confidence" value="very_confident"> Very confident
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="confidence" value="confident"> Confident
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="confidence" value="neutral"> Neutral
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="confidence" value="not_very_confident"> Not very confident
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="confidence" value="not_confident_at_all"> Not confident at all
                        </label>
                    </div>
                </div>

                <div class="survey-question required-question">
                    <label><strong>3. Do you often notice your own spelling mistakes in your daily work or studies? *</strong></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="notice_mistakes" value="yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="notice_mistakes" value="no"> No
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="notice_mistakes" value="not_sure"> Not sure
                        </label>
                    </div>
                </div>

                <div class="survey-question required-question">
                    <label><strong>4. Do you use a spell checker in your daily work or studies? *</strong></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="use_spell_checker" value="yes" onchange="toggleSpellCheckerQuestions(true)"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="use_spell_checker" value="no" onchange="toggleSpellCheckerQuestions(false)"> No
                        </label>
                    </div>
                </div>

                <div class="survey-question" id="spellCheckerSubQuestions" style="display: none;">
                    <label><strong>4-1. Which spell-checking tools do you use? (Select all that apply)</strong></label>
                    <div style="margin-top: 10px;">
                        <label class="radio-option" style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="spell_checker_tools" value="microsoft_word"> Microsoft Word Spell Checker
                        </label>
                        <label class="radio-option" style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="spell_checker_tools" value="google_docs"> Google Docs Spell Checker
                        </label>
                        <label class="radio-option" style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="spell_checker_tools" value="grammarly"> Grammarly
                        </label>
                        <label class="radio-option" style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="spell_checker_tools" value="browser_spell_checker"> Built-in browser spell checker (e.g., Chrome, Firefox)
                        </label>
                        <label class="radio-option" style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="spell_checker_tools" value="mobile_autocorrect"> Mobile keyboard autocorrect (e.g., Gboard, iOS)
                        </label>
                        <label class="radio-option" style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" name="spell_checker_tools" value="other" onchange="toggleOtherInput(this)"> Other:
                            <input type="text" id="otherSpellChecker" placeholder="Please specify..." style="margin-left: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 200px;" disabled>
                        </label>
                    </div>

                    <div style="margin-top: 20px;">
                        <label><strong>4-2. Does using a spell checker help you avoid making the same mistakes in the future? *</strong></label>
                        <div class="radio-group" style="margin-top: 10px;">
                            <label class="radio-option">
                                <input type="radio" name="spell_checker_helpful" value="very_helpful"> Very helpful
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="spell_checker_helpful" value="helpful"> Helpful
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="spell_checker_helpful" value="neutral"> Neutral
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="spell_checker_helpful" value="not_very_helpful"> Not very helpful
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="spell_checker_helpful" value="not_helpful_at_all"> Not helpful at all
                            </label>
                        </div>
                    </div>
                </div>

                <div class="survey-question required-question">
                    <label><strong>5. After Phase 1, there was a stage to confirm your mistakes. Did you proofread your writing at that stage? *</strong></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="proofreading" value="carefully_proofread"> Yes, I carefully proofread and checked the corrections.
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="proofreading" value="briefly_looked"> Yes, I briefly looked at the mistakes.
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="proofreading" value="skipped"> No, I skipped the proofreading stage.
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="proofreading" value="dont_remember"> I don't remember.
                        </label>
                    </div>
                </div>

                <div class="survey-question required-question">
                    <label><strong>6. For the mistakes pointed out in Phase 1, did you improve on them in Phase 2? *</strong></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="improvement" value="corrected_most"> Yes, I corrected most or all of them.
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="improvement" value="corrected_some"> I corrected some of them.
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="improvement" value="tried_but_failed"> I tried, but I still made the same mistakes.
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="improvement" value="didnt_try"> I didn't try to improve them.
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="improvement" value="dont_remember"> I don't remember.
                        </label>
                    </div>
                </div>

                <div class="button-group">
                    <button class="submit-button" onclick="completeExperiment()">
                        <span class="loading-spinner" id="submitSpinner"></span>
                        Submit Final Results âœ“
                    </button>
                </div>
            </div>
        </div>

        <!-- Stage 5: Completion -->
        <div class="stage" id="stage5">
            <div class="completion-message">
                <h2>ğŸ‰ Experiment Complete!</h2>
                <p>Thank you for participating in our experiment!</p>
                
            </div>
        </div>
    </div>

    <script>
        // ============ Firebaseé…ç½® ============
                 const firebaseConfig = {
                apiKey: "AIzaSyDqo6mGblUWNrzEkigIyt9YaSXJS2zpxsg",
               authDomain: "audio-listening-experime-257b2.firebaseapp.com",
               projectId: "audio-listening-experime-257b2",
                storageBucket: "audio-listening-experime-257b2.firebasestorage.app",
               messagingSenderId: "489014203991",
               appId: "1:489014203991:web:2fe3ceb5939da84c75f512",
               measurementId: "G-3NKKYXHS0X"
                 };


        // æ£€æŸ¥Firebaseé…ç½®æ˜¯å¦å·²æ›´æ–°
        function checkFirebaseConfig() {
            const isConfigured = !firebaseConfig.apiKey.includes('è¯·æ›¿æ¢');
            const statusElement = document.getElementById('firebaseStatus');
            
            if (!isConfigured) {
                statusElement.textContent = 'âŒ Please configure Firebase information first';
                statusElement.className = 'firebase-status';
                console.error('ğŸ”¥ Firebaseé…ç½®æœªå®Œæˆï¼è¯·æŒ‰ç…§æŒ‡å—é…ç½®Firebaseä¿¡æ¯ã€‚');
                return false;
            }
            
            return true;
        }

        // Firebaseåˆå§‹åŒ–
        let db = null;
        let firebaseInitialized = false;

        async function initializeFirebase() {
            if (!checkFirebaseConfig()) {
                return false;
            }

            try {
                document.getElementById('firebaseStatus').textContent = 'ğŸ”„ Connecting to Firebase...';
                document.getElementById('firebaseStatus').className = 'firebase-status connecting';
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // æµ‹è¯•è¿æ¥
                await db.collection('test').get();
                
                document.getElementById('firebaseStatus').textContent = 'âœ… Firebase Connected';
                document.getElementById('firebaseStatus').className = 'firebase-status connected';
                
                firebaseInitialized = true;
                console.log('ğŸ”¥ Firebaseåˆå§‹åŒ–æˆåŠŸï¼');
                return true;
            } catch (error) {
                document.getElementById('firebaseStatus').textContent = 'âŒ Firebase Connection Failed';
                document.getElementById('firebaseStatus').className = 'firebase-status';
                console.error('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        // ============ å…¨å±€å˜é‡ ============
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let currentPhase = 'phase1';
        let isReviewPhase = false;
        let mouseClickData = [];
        
        // æ–°å¢ï¼šæ’­æ”¾æŒ‰é’®ç‚¹å‡»è®¡æ•°
        let playButtonClickCounts = {
            phase1: {}, // æŒ‰é—®é¢˜ç´¢å¼•è®°å½•ç‚¹å‡»æ¬¡æ•° {0: 3, 1: 2, ...}
            phase2: {}
        };
        let currentQuestionPlayCount = 0; // å½“å‰é—®é¢˜çš„æ’­æ”¾æ¬¡æ•°
        
        // åŸæœ‰å®éªŒæ•°æ®ç»“æ„
        let experimentData = {
            participantId: 'P' + Date.now(),
            prolificPID: null,
            round1Answers: [],
            round2Answers: [],
            reviewPhaseClicks: [],
            spellCheckClicks: 0,
            timestamps: { start: Date.now() },
            // æ–°å¢ï¼šæ’­æ”¾æŒ‰é’®ç»Ÿè®¡æ•°æ®
            playButtonStats: {
                phase1TotalClicks: 0,
                phase2TotalClicks: 0,
                phase1DetailedClicks: {},
                phase2DetailedClicks: {},
                averageClicksPerQuestion: 0
            }
        };

        // 50ä¸ªé—®é¢˜æ•°æ®
        const audioQuestions = [
            { sentence: "The government has ____ that the new tax policy has been a disaster.", answer: "concede", audio: "audio/concede.mp3" },
            { sentence: "He's got a lot of ____ degrees and awards from educational establishments worldwide.", answer: "honorary", audio: "audio/honorary.mp3" },
            { sentence: "As people ____ more wealth, they tend to spend a greater proportion of their incomes.", answer: "accumulate", audio: "audio/accumulate.mp3" },
            { sentence: "Plant growth is most ____ in spring and early summer.", answer: "noticeable", audio: "audio/noticeable.mp3" },
            { sentence: "The ____ is to perform its last ever concert tomorrow night at the Albert Hall.", answer: "orchestra", audio: "audio/orchestra.mp3" },
            { sentence: "Public ____ about the disease is still a cause for concern.", answer: "ignorance", audio: "audio/ignorance.mp3" },
            { sentence: "The president does not want to answer any ____ questions.", answer: "theoretical", audio: "audio/theoretical.mp3" },
            { sentence: "Education should be ____ to the child's needs.", answer: "relevant", audio: "audio/relevant.mp3" },
            { sentence: "His father is buried in the ____ on the hill.", answer: "cemetery", audio: "audio/cemetery.mp3" },
            { sentence: "Although the play was written hundreds of years ago, it still has a ____ feel to it.", answer: "contemporary", audio: "audio/contemporary.mp3" },
            { sentence: "He is blessed with both good looks and ____.", answer: "intelligence", audio: "audio/intelligence.mp3" },
            { sentence: "He was brought up on a diet of political ____ from birth.", answer: "propaganda", audio: "audio/propaganda.mp3" },
            { sentence: "This recipe should be ____ for five people.", answer: "sufficient", audio: "audio/sufficient.mp3" },
            { sentence: "Young people don't always appreciate the ____ offered by their parents and teachers.", answer: "guidance", audio: "audio/guidance.mp3" },
            { sentence: "Not making a will can have serious ____ for your children and other family members.", answer: "consequence", audio: "audio/consequence.mp3" },
            { sentence: "The country is run on socialist ____.", answer: "principle", audio: "audio/principle.mp3" },
            { sentence: "Any help you could give me would be greatly ____.", answer: "appreciate", audio: "audio/appreciate.mp3" },
            { sentence: "He was arrested for taking part in ____ activities.", answer: "revolutionary", audio: "audio/revolutionary.mp3" },
            { sentence: "I think it helps if you have an ____ personality.", answer: "extrovert", audio: "audio/extrovert.mp3" },
            { sentence: "With the extra resources, the project now seems ____.", answer: "feasible", audio: "audio/feasible.mp3" },
            { sentence: "That party was too ____ for me!", answer: "bizarre", audio: "audio/bizarre.mp3" },
            { sentence: "The finance ____ controls the school's budget.", answer: "committee", audio: "audio/committee.mp3" },
            { sentence: "I like the ____ of living close to work.", answer: "convenience", audio: "audio/convenience.mp3" },
            { sentence: "It was when we started living together that we found we just weren't ____.", answer: "compatible", audio: "audio/compatible.mp3" },
            { sentence: "He told the ____ story of his escape.", answer: "extraordinary", audio: "audio/extraordinary.mp3" },
            { sentence: "He told one or two ____ stories about his years as a policeman.", answer: "humorous", audio: "audio/humorous.mp3" },
            { sentence: "We really ought to leave ____.", answer: "immediately", audio: "audio/immediately.mp3" },
            { sentence: "An ____ inquiry will determine whether the case should move forward.", answer: "independent", audio: "audio/independent.mp3" },
            { sentence: "He decided to ____ a career in television.", answer: "pursue", audio: "audio/pursue.mp3" },
            { sentence: "She has shown herself to be a highly ____ manager.", answer: "competent", audio: "audio/competent.mp3" },
            { sentence: "The children have no ____ of being different.", answer: "consciousness", audio: "audio/consciousness.mp3" },
            { sentence: "An old ____ for 2012 was still hanging on the wall of her office.", answer: "calendar", audio: "audio/calendar.mp3" },
            { sentence: "The general ____ in the office is that he can't do his job.", answer: "consensus", audio: "audio/consensus.mp3" },
            { sentence: "The sun ____ behind heavy clouds.", answer: "disappear", audio: "audio/disappear.mp3" },
            { sentence: "I'm sorry to ____ you, but I'm afraid I can't come after all.", answer: "disappoint", audio: "audio/disappoint.mp3" },
            { sentence: "Such a war would be ____ for the country.", answer: "disastrous", audio: "audio/disastrous.mp3" },
            { sentence: "Some monkeys have a very complex social ____.", answer: "hierarchy", audio: "audio/hierarchy.mp3" },
            { sentence: "We met on several ____ to discuss the issue.", answer: "occasion", audio: "audio/occasion.mp3" },
            { sentence: "I had the ____ of interviewing Picasso in the 1960s.", answer: "privilege", audio: "audio/privilege.mp3" },
            { sentence: "Store fruit juice in the ____.", answer: "refrigerator", audio: "audio/refrigerator.mp3" },
            { sentence: "I didn't want to ____ her in front of her friends.", answer: "embarrass", audio: "audio/embarrass.mp3" },
            { sentence: "The art department and the music department are in two ____ buildings.", answer: "separate", audio: "audio/separate.mp3" },
            { sentence: "She ____ for her husband's rudeness.", answer: "apologize", audio: "audio/apologize.mp3" },
            { sentence: "I'll be living here for the ____ future.", answer: "foreseeable", audio: "audio/foreseeable.mp3" },
            { sentence: "She gave me one of those ____ smiles and I just had to agree.", answer: "irresistible", audio: "audio/irresistible.mp3" },
            { sentence: "Imagine what the world will be like at the end of the next ____.", answer: "millennium", audio: "audio/millennium.mp3" },
            { sentence: "There are two different ____ of this word.", answer: "pronunciation", audio: "audio/pronunciation.mp3" },
            { sentence: "Visitors to the country have been asked to fill out a detailed ____.", answer: "questionnaire", audio: "audio/questionnaire.mp3" },
            { sentence: "He ____ said he'd be here.", answer: "definitely", audio: "audio/definitely.mp3" },
            { sentence: "Death was an everyday ____ during the Civil War.", answer: "occurrence", audio: "audio/occurrence.mp3" }
        ];

        let currentQuestionIndex = 0;
        let countdownTimer = null;
        let currentAudio = null;

        // ============ æ–°å¢åŠŸèƒ½ï¼šæ’­æ”¾æŒ‰é’®ç‚¹å‡»ç»Ÿè®¡ (åå°è®°å½•ï¼Œä¸æ˜¾ç¤º) ============
        function incrementPlayCount(phase) {
            currentQuestionPlayCount++;
            
            // åå°è®°å½•æ•°æ®ï¼Œä¸æ›´æ–°ç•Œé¢æ˜¾ç¤º
            if (phase === 'phase1') {
                playButtonClickCounts.phase1[currentQuestionIndex] = currentQuestionPlayCount;
                experimentData.playButtonStats.phase1TotalClicks++;
                experimentData.playButtonStats.phase1DetailedClicks[currentQuestionIndex] = currentQuestionPlayCount;
            } else if (phase === 'phase2') {
                playButtonClickCounts.phase2[currentQuestionIndex] = currentQuestionPlayCount;
                experimentData.playButtonStats.phase2TotalClicks++;
                experimentData.playButtonStats.phase2DetailedClicks[currentQuestionIndex] = currentQuestionPlayCount;
            }
            
            console.log(`ğŸ“Š æ’­æ”¾ç»Ÿè®¡ - ${phase} é—®é¢˜${currentQuestionIndex + 1}: ${currentQuestionPlayCount}æ¬¡æ’­æ”¾ (åå°è®°å½•)`);
        }

        function resetPlayCount() {
            currentQuestionPlayCount = 0;
            // ä¸éœ€è¦éšè—ç•Œé¢å…ƒç´ ï¼Œå› ä¸ºç•Œé¢ä¸æ˜¾ç¤ºæ’­æ”¾æ¬¡æ•°
        }

        // ============ æ–°å¢åŠŸèƒ½ï¼šä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹ ============
        function maintainInputFocus() {
            // åœ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®åï¼Œå»¶è¿Ÿä¸€å°æ®µæ—¶é—´å†é‡æ–°èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                const activeStage = document.querySelector('.stage.active');
                if (activeStage) {
                    let inputElement = null;
                    if (activeStage.id === 'stage1') {
                        inputElement = document.getElementById('answerInput');
                    } else if (activeStage.id === 'stage3') {
                        inputElement = document.getElementById('answerInput2');
                    }
                    
                    if (inputElement) {
                        inputElement.focus();
                        // ç¡®ä¿å…‰æ ‡åœ¨è¾“å…¥æ¡†æœ«å°¾
                        const length = inputElement.value.length;
                        inputElement.setSelectionRange(length, length);
                    }
                }
            }, 100);
        }

        // ============ Firebaseæ•°æ®è®°å½•å‡½æ•° ============
        async function initializeExperiment() {
            if (!firebaseInitialized) {
                console.log('âš ï¸ Firebaseæœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ•°æ®è®°å½•');
                return;
            }

            try {
                // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„Prolific ID
                const prolificId = experimentData.prolificPID || 'manual_input_' + Date.now();
                
                await db.collection('audio_experiment_sessions').doc(sessionId).set({
                    participantId: experimentData.participantId,
                    prolificId: prolificId,
                    startTime: firebase.firestore.Timestamp.now(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    phase1_completed: false,
                    phase2_completed: false,
                    experiment_completed: false,
                    created_at: firebase.firestore.Timestamp.now()
                });
                
                console.log('ğŸ”¥ å®éªŒä¼šè¯å·²åˆ›å»º, Session ID:', sessionId);
            } catch (error) {
                console.error('âŒ åˆ›å»ºå®éªŒä¼šè¯å¤±è´¥:', error);
            }
        }

        async function recordPhase1Answer(questionNumber, audioFile, userAnswer, correctAnswer, responseTime, playCount) {
            if (!firebaseInitialized) return;
            
            try {
                const answerData = {
                    sessionId: sessionId,
                    phase: 'phase1',
                    questionNumber: questionNumber,
                    audioFile: audioFile,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: strictAnswerCheck(userAnswer, correctAnswer), // ä½¿ç”¨åŒ…å«åŒ¹é…
                    isCorrectExact: exactAnswerCheck(userAnswer, correctAnswer), // æ–°å¢ï¼šä¸¥æ ¼åŒ¹é…ç»“æœ
                    isCorrectContains: strictAnswerCheck(userAnswer, correctAnswer), // æ–°å¢ï¼šåŒ…å«åŒ¹é…ç»“æœ
                    responseTime: responseTime,
                    playButtonClicks: playCount, // æ–°å¢ï¼šæ’­æ”¾æ¬¡æ•°
                    timestamp: firebase.firestore.Timestamp.now()
                };
                
                await db.collection('phase1_answers').add(answerData);
                console.log(`ğŸ“ é˜¶æ®µ1 é—®é¢˜${questionNumber} å·²è®°å½• (æ’­æ”¾${playCount}æ¬¡, åŒ…å«åŒ¹é…: ${answerData.isCorrect})`);
                
                if (questionNumber === 50) {
                    await db.collection('audio_experiment_sessions').doc(sessionId).update({
                        phase1_completed: true,
                        phase1_completion_time: firebase.firestore.Timestamp.now()
                    });
                }
            } catch (error) {
                console.error('âŒ è®°å½•é˜¶æ®µ1ç­”æ¡ˆå¤±è´¥:', error);
            }
        }

        async function recordPhase2Answer(questionNumber, audioFile, userAnswer, correctAnswer, responseTime, playCount) {
            if (!firebaseInitialized) return;
            
            try {
                const answerData = {
                    sessionId: sessionId,
                    phase: 'phase2',
                    questionNumber: questionNumber + 50, // 51-100
                    audioFile: audioFile,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: strictAnswerCheck(userAnswer, correctAnswer), // ä½¿ç”¨åŒ…å«åŒ¹é…
                    isCorrectExact: exactAnswerCheck(userAnswer, correctAnswer), // æ–°å¢ï¼šä¸¥æ ¼åŒ¹é…ç»“æœ
                    isCorrectContains: strictAnswerCheck(userAnswer, correctAnswer), // æ–°å¢ï¼šåŒ…å«åŒ¹é…ç»“æœ
                    responseTime: responseTime,
                    playButtonClicks: playCount, // æ–°å¢ï¼šæ’­æ”¾æ¬¡æ•°
                    timestamp: firebase.firestore.Timestamp.now()
                };
                
                await db.collection('phase2_answers').add(answerData);
                console.log(`ğŸ“ é˜¶æ®µ2 é—®é¢˜${questionNumber + 50} å·²è®°å½• (æ’­æ”¾${playCount}æ¬¡, åŒ…å«åŒ¹é…: ${answerData.isCorrect})`);
                
                if (questionNumber === 49) { // ç¬¬äºŒè½®çš„ç¬¬50é¢˜
                    await db.collection('audio_experiment_sessions').doc(sessionId).update({
                        phase2_completed: true,
                        phase2_completion_time: firebase.firestore.Timestamp.now(),
                        experiment_completed: true,
                        total_completion_time: firebase.firestore.Timestamp.now()
                    });
                }
            } catch (error) {
                console.error('âŒ è®°å½•é˜¶æ®µ2ç­”æ¡ˆå¤±è´¥:', error);
            }
        }

        // æ–°å¢ï¼šè®°å½•æ’­æ”¾æŒ‰é’®ç»Ÿè®¡æ•°æ®
        async function recordPlayButtonStats() {
            if (!firebaseInitialized) return;
            
            try {
                const statsData = {
                    sessionId: sessionId,
                    phase1TotalClicks: experimentData.playButtonStats.phase1TotalClicks,
                    phase2TotalClicks: experimentData.playButtonStats.phase2TotalClicks,
                    totalClicks: experimentData.playButtonStats.phase1TotalClicks + experimentData.playButtonStats.phase2TotalClicks,
                    phase1DetailedClicks: experimentData.playButtonStats.phase1DetailedClicks,
                    phase2DetailedClicks: experimentData.playButtonStats.phase2DetailedClicks,
                    averageClicksPerQuestion: (experimentData.playButtonStats.phase1TotalClicks + experimentData.playButtonStats.phase2TotalClicks) / 100,
                    timestamp: firebase.firestore.Timestamp.now()
                };
                
                await db.collection('play_button_statistics').add(statsData);
                console.log('ğŸ“Š æ’­æ”¾æŒ‰é’®ç»Ÿè®¡æ•°æ®å·²ä¿å­˜');
            } catch (error) {
                console.error('âŒ ä¿å­˜æ’­æ”¾æŒ‰é’®ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // ============ é¼ æ ‡è¿½è¸ªå‡½æ•° (åªåœ¨Reviewé˜¶æ®µï¼Œç®€åŒ–æ•°æ®) ============
        function startMouseTracking() {
            isReviewPhase = true;
            mouseClickData = [];
            console.log('ğŸ–±ï¸ å¼€å§‹è¿½è¸ªReviewé˜¶æ®µé¼ æ ‡ç‚¹å‡»');
            
            document.addEventListener('click', recordMouseClick);
        }

        function recordMouseClick(event) {
            if (!isReviewPhase) return;
            
            // ç®€åŒ–çš„ç‚¹å‡»æ•°æ® - åªè®°å½•å†…å®¹å’Œæ—¶é—´
            const clickData = {
                type: 'click',
                timestamp: new Date().toLocaleString('zh-CN'),
                clickedText: event.target.textContent?.substring(0, 100) || '',
                elementType: event.target.tagName || '',
                elementClass: event.target.className || '',
                isSpellCheck: event.target.className?.includes('spell-error-text') || false,
                isButton: event.target.tagName === 'BUTTON',
                questionNumber: null // é»˜è®¤ä¸ºnullï¼Œåé¢ä¼šæ ¹æ®æƒ…å†µè®¾ç½®
            };
            
            // å¦‚æœæ˜¯æ‹¼å†™æ£€æŸ¥ç‚¹å‡»ï¼Œå°è¯•è·å–å¯¹åº”çš„é—®é¢˜å·ç 
            if (clickData.isSpellCheck) {
                // æŸ¥æ‰¾åŒ…å«æ­¤å…ƒç´ çš„é—®é¢˜æ®µè½
                let parentElement = event.target.parentElement;
                while (parentElement) {
                    const textContent = parentElement.textContent;
                    // æŸ¥æ‰¾ç±»ä¼¼ "1. " çš„é—®é¢˜ç¼–å·æ¨¡å¼
                    const questionMatch = textContent.match(/^(\d+)\.\s/);
                    if (questionMatch) {
                        clickData.questionNumber = parseInt(questionMatch[1]);
                        break;
                    }
                    parentElement = parentElement.parentElement;
                }
            }
            
            mouseClickData.push(clickData);
            experimentData.reviewPhaseClicks.push(clickData);
            console.log('ğŸ–±ï¸ Reviewç‚¹å‡»è®°å½•:', clickData);
        }

        // ç§»é™¤æ»šåŠ¨å’ŒæŒ‰é”®è¿½è¸ª
        function recordScrollEvent(event) {
            // ä¸å†è®°å½•æ»šåŠ¨äº‹ä»¶
        }

        function recordKeyPress(event) {
            // ä¸å†è®°å½•æŒ‰é”®äº‹ä»¶
        }

        async function saveMouseTrackingData() {
            if (!firebaseInitialized || mouseClickData.length === 0) return;
            
            try {
                const trackingData = {
                    sessionId: sessionId,
                    phase: 'review_page',
                    totalClicks: mouseClickData.length,
                    spellCheckClicks: mouseClickData.filter(d => d.isSpellCheck).length,
                    buttonClicks: mouseClickData.filter(d => d.isButton).length,
                    clickDetails: mouseClickData, // ç®€åŒ–çš„ç‚¹å‡»æ•°æ®
                    timestamp: firebase.firestore.Timestamp.now()
                };
                
                await db.collection('confirmation_page_interactions').add(trackingData);
                console.log('ğŸ–±ï¸ Reviewé˜¶æ®µäº¤äº’æ•°æ®å·²ä¿å­˜');
                
                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('click', recordMouseClick);
                
                isReviewPhase = false;
                mouseClickData = [];
            } catch (error) {
                console.error('âŒ ä¿å­˜é¼ æ ‡è¿½è¸ªæ•°æ®å¤±è´¥:', error);
            }
        }

        // ============ æ¬¢è¿é¡µé¢å’Œå®éªŒå¼€å§‹ ============
        function startExperiment() {
            const prolificId = document.getElementById('prolificIdInput').value.trim();
            
            if (!prolificId) {
                document.getElementById('welcomeErrorMessage').style.display = 'block';
                document.getElementById('prolificIdInput').focus();
                return;
            }
            
            // ä¿å­˜Prolific ID
            experimentData.prolificPID = prolificId;
            
            // åˆ‡æ¢åˆ°ç¬¬ä¸€é˜¶æ®µ
            document.getElementById('welcomeStage').classList.remove('active');
            document.getElementById('stage1').classList.add('active');
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º - æ¸…ç©ºè¿›åº¦æ¡æ–‡æœ¬
            document.getElementById('progressText').textContent = '';
            
            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªé—®é¢˜
            setTimeout(() => {
                initializeQuestion();
            }, 500);
        }
        // åˆå§‹åŒ–Prolificæ•°æ® - ä¿®æ”¹ä¸ºä»è¾“å…¥æ¡†è·å–
        function initializeProlificData() {
            // Prolific IDç°åœ¨ä»ç”¨æˆ·è¾“å…¥è·å–ï¼Œä¸å†ä»URLå‚æ•°è·å–
            const prolificId = experimentData.prolificPID || 'MANUAL_INPUT';
            console.log('Prolific IDè®¾ç½®ä¸º:', prolificId);
        }

        function trackReviewClick(type, data) {
            experimentData.reviewPhaseClicks.push({
                type: type,
                data: data,
                timestamp: Date.now(),
                coordinates: { x: event.clientX, y: event.clientY }
            });
        }

        function sendDataToServer(type, data) {
            console.log('ğŸ“¤ Sending data:', type, data);
        }

        function strictAnswerCheck(userAnswer, correctAnswer) {
            // æ–°çš„åŒ…å«åŒ¹é…é€»è¾‘ - åªè¦ç”¨æˆ·ç­”æ¡ˆåŒ…å«ç›®æ ‡è¯æ±‡å°±ç®—æ­£ç¡®
            const userAnswerLower = userAnswer.toLowerCase().trim();
            const correctAnswerLower = correctAnswer.toLowerCase().trim();
            
            // æ£€æŸ¥ç”¨æˆ·ç­”æ¡ˆæ˜¯å¦åŒ…å«æ­£ç¡®ç­”æ¡ˆ
            const isContained = userAnswerLower.includes(correctAnswerLower);
            
            console.log(`ğŸ“ ç­”æ¡ˆæ£€æŸ¥: ç”¨æˆ·ç­”æ¡ˆ"${userAnswer}" ${isContained ? 'åŒ…å«' : 'ä¸åŒ…å«'} ç›®æ ‡è¯æ±‡"${correctAnswer}"`);
            
            return isContained;
        }

        // æ–°å¢ï¼šä¸ºäº†å‘åå…¼å®¹ï¼Œä¿ç•™åŸå§‹ä¸¥æ ¼åŒ¹é…å‡½æ•°
        function exactAnswerCheck(userAnswer, correctAnswer) {
            return userAnswer.trim() === correctAnswer.trim();
        }

        function calculateAccuracy(answers) {
            if (answers.length === 0) return 0;
            const correct = answers.filter(answer => 
                strictAnswerCheck(answer.userAnswer, answer.correctAnswer) // ä½¿ç”¨æ–°çš„åŒ…å«åŒ¹é…é€»è¾‘
            ).length;
            return Math.round((correct / answers.length) * 100);
        }

        function startCountdown(buttonId, countdownId) {
            const button = document.getElementById(buttonId);
            const countdownElement = document.getElementById(countdownId);
            
            if (!button || !countdownElement) return;
            
            let timeLeft = 1;
            countdownElement.textContent = timeLeft;
            
            if (countdownTimer) clearInterval(countdownTimer);
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    playRealAudio(buttonId);
                }
            }, 1000);
        }

        // é¡µé¢è·³è½¬åè‡ªåŠ¨å¼€å§‹å€’è®¡æ—¶å’ŒéŸ³é¢‘æ’­æ”¾
        function autoStartAudio() {
            setTimeout(() => {
                const activeStage = document.querySelector('.stage.active');
                if (!activeStage) return;
                
                if (activeStage.id === 'stage1') {
                    startCountdown('playButton', 'countdown');
                } else if (activeStage.id === 'stage3') {
                    startCountdown('playButton2', 'countdown2');
                }
            }, 500); // å¢åŠ å»¶è¿Ÿç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
        }

        // å¼ºåˆ¶è‡ªåŠ¨æ’­æ”¾ - ä¿®å¤æ‰€æœ‰é¡µé¢çš„éŸ³é¢‘æ’­æ”¾
        function forceAutoPlay() {
            const activeStage = document.querySelector('.stage.active');
            if (!activeStage) return;
            
            let buttonId, countdownId;
            if (activeStage.id === 'stage1') {
                buttonId = 'playButton';
                countdownId = 'countdown';
            } else if (activeStage.id === 'stage3') {
                buttonId = 'playButton2';
                countdownId = 'countdown2';
            } else {
                return;
            }
            
            const button = document.getElementById(buttonId);
            const countdownElement = document.getElementById(countdownId);
            
            if (!button || !countdownElement) return;
            
            // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
            if (countdownTimer) clearInterval(countdownTimer);
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            button.disabled = false;
            
            // ç«‹å³å¼€å§‹å€’è®¡æ—¶
            let timeLeft = 1;
            countdownElement.textContent = timeLeft;
            button.textContent = `ğŸ”Š Auto-play in ${timeLeft}s`;
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                button.textContent = `ğŸ”Š Auto-play in ${timeLeft}s`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    // ç¡®ä¿éŸ³é¢‘èƒ½å¤Ÿæ’­æ”¾
                    setTimeout(() => {
                        playRealAudio(buttonId);
                    }, 100);
                }
            }, 1000);
        }

        function playRealAudio(buttonId) {
            const button = document.getElementById(buttonId);
            const question = audioQuestions[currentQuestionIndex];
            
            // è®°å½•æ’­æ”¾æ¬¡æ•°
            const currentPhase = (buttonId === 'playButton') ? 'phase1' : 'phase2';
            incrementPlayCount(currentPhase);
            
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            
            button.textContent = 'ğŸ”Š Playing Audio...';
            button.disabled = true;
            
            currentAudio = new Audio(question.audio);
            currentAudio.preload = 'auto';
            currentAudio.volume = 0.8;
            
            currentAudio.addEventListener('loadeddata', () => {
                const playPromise = currentAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Audio playing successfully');
                    }).catch(error => {
                        console.log('Autoplay blocked, user interaction required:', error);
                        button.textContent = 'ğŸ”Š Click to Play Audio';
                        button.disabled = false;
                        
                        button.onclick = function() {
                            currentAudio.play();
                            button.textContent = 'ğŸ”Š Playing Audio...';
                            button.disabled = true;
                        };
                    });
                }
            });
            
            currentAudio.addEventListener('ended', () => {
                button.textContent = 'ğŸ”Š Play Again';
                button.disabled = false;
                
                if (buttonId === 'playButton') {
                    button.onclick = playAudio;
                } else {
                    button.onclick = playAudio2;
                }
                
                // ä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹
                maintainInputFocus();
            });
            
            currentAudio.addEventListener('error', (e) => {
                console.error('Audio loading error:', e);
                button.textContent = 'ğŸ”Š Audio Error - Click to Retry';
                button.disabled = false;
                
                button.onclick = function() {
                    playRealAudio(buttonId);
                };
            });
            
            // åœ¨éŸ³é¢‘å¼€å§‹æ’­æ”¾åç«‹å³æ¢å¤è¾“å…¥æ¡†ç„¦ç‚¹
            setTimeout(() => {
                maintainInputFocus();
            }, 200);
        }

        function initializeQuestion() {
            if (currentQuestionIndex < audioQuestions.length) {
                const question = audioQuestions[currentQuestionIndex];
                const sentenceWithBlank = question.sentence.replace('____', 
                    '<input type="text" class="input-field" id="answerInput" placeholder="____" autocomplete="off">');
                
                document.getElementById('sentenceDisplay').innerHTML = sentenceWithBlank;
                document.getElementById('questionNumber').textContent = `${currentQuestionIndex + 1} / 50`;
                
                // ä¿æŒå…¨å±€è¿›åº¦ (0-50% for Phase 1)
                const progress = (currentQuestionIndex / audioQuestions.length) * 50;
                document.getElementById('progressFill').style.width = progress + '%';
                
                document.getElementById('errorMessage').style.display = 'none';
                
                // é‡ç½®æ’­æ”¾è®¡æ•°
                resetPlayCount();
                
                // é‡ç½®æ’­æ”¾æŒ‰é’®
                const button = document.getElementById('playButton');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'ğŸ”Š Auto-play in 1s';
                }
                
                // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                setTimeout(() => {
                    const input = document.getElementById('answerInput');
                    if (input) input.focus();
                }, 100);
                
                // å¼ºåˆ¶è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘ - å¢åŠ å»¶è¿Ÿç¡®ä¿æˆåŠŸ
                setTimeout(() => {
                    forceAutoPlay();
                }, 1000);
            }
        }

        // ä¿®å¤é—®é¢˜1ï¼šé˜¶æ®µ3çš„è¿›åº¦æ¡æ›´æ–°å‡½æ•°
        function initializeQuestion2() {
            if (currentQuestionIndex < audioQuestions.length) {
                const question = audioQuestions[currentQuestionIndex];
                const sentenceWithBlank = question.sentence.replace('____', 
                    '<input type="text" class="input-field" id="answerInput2" placeholder="____" autocomplete="off">');
                
                document.getElementById('sentenceDisplay2').innerHTML = sentenceWithBlank;
                document.getElementById('questionNumber2').textContent = `${currentQuestionIndex + 1} / 50`;
                
                // ä¿æŒå…¨å±€è¿›åº¦ (50-100% for Phase 2)
                const progress = 50 + (currentQuestionIndex / audioQuestions.length) * 50;
                document.getElementById('progressFill2').style.width = progress + '%';
                
                document.getElementById('errorMessage2').style.display = 'none';
                
                // é‡ç½®æ’­æ”¾è®¡æ•°
                resetPlayCount();
                
                // é‡ç½®æ’­æ”¾æŒ‰é’®
                const button = document.getElementById('playButton2');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'ğŸ”Š Auto-play in 1s';
                }
                
                // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                setTimeout(() => {
                    const input = document.getElementById('answerInput2');
                    if (input) input.focus();
                }, 100);
                
                // å¼ºåˆ¶è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘ - å¢åŠ å»¶è¿Ÿç¡®ä¿æˆåŠŸ
                setTimeout(() => {
                    forceAutoPlay();
                }, 1000);
            }
        }

        function playAudio() {
            if (countdownTimer) clearInterval(countdownTimer);
            playRealAudio('playButton');
        }

        function playAudio2() {
            if (countdownTimer) clearInterval(countdownTimer);
            playRealAudio('playButton2');
        }

        function nextQuestion() {
            const input = document.getElementById('answerInput');
            const answer = input ? input.value.trim() : '';
            
            if (!answer) {
                document.getElementById('errorMessage').style.display = 'block';
                if (input) input.focus();
                return;
            }
            
            const correctAnswer = audioQuestions[currentQuestionIndex].answer;
            const isCorrect = strictAnswerCheck(answer, correctAnswer); // ä½¿ç”¨åŒ…å«åŒ¹é…
            const responseTime = Date.now() - experimentData.timestamps.start;
            const playCount = currentQuestionPlayCount;
            
            experimentData.round1Answers.push({
                questionIndex: currentQuestionIndex,
                userAnswer: answer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: Date.now(),
                playCount: playCount, // æ–°å¢ï¼šè®°å½•æ’­æ”¾æ¬¡æ•°
                // æ–°å¢ï¼šè®°å½•ä¸¤ç§åˆ¤å®šç»“æœä»¥ä¾¿åˆ†æ
                isCorrectExact: exactAnswerCheck(answer, correctAnswer), // ä¸¥æ ¼åŒ¹é…ç»“æœ
                isCorrectContains: isCorrect // åŒ…å«åŒ¹é…ç»“æœ (å½“å‰ä½¿ç”¨çš„æ ‡å‡†)
            });
            
            // Firebaseè®°å½•
            recordPhase1Answer(
                currentQuestionIndex + 1, 
                audioQuestions[currentQuestionIndex].audio,
                answer,
                correctAnswer,
                responseTime,
                playCount // æ–°å¢ï¼šä¼ é€’æ’­æ”¾æ¬¡æ•°
            );
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= audioQuestions.length) {
                goToStage2();
            } else {
                initializeQuestion();
            }
        }

        function nextQuestion2() {
            const input = document.getElementById('answerInput2');
            const answer = input ? input.value.trim() : '';
            
            if (!answer) {
                document.getElementById('errorMessage2').style.display = 'block';
                if (input) input.focus();
                return;
            }
            
            const correctAnswer = audioQuestions[currentQuestionIndex].answer;
            const isCorrect = strictAnswerCheck(answer, correctAnswer); // ä½¿ç”¨åŒ…å«åŒ¹é…
            const responseTime = Date.now() - experimentData.timestamps.start;
            const playCount = currentQuestionPlayCount;
            
            experimentData.round2Answers.push({
                questionIndex: currentQuestionIndex,
                userAnswer: answer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: Date.now(),
                playCount: playCount, // æ–°å¢ï¼šè®°å½•æ’­æ”¾æ¬¡æ•°
                // æ–°å¢ï¼šè®°å½•ä¸¤ç§åˆ¤å®šç»“æœä»¥ä¾¿åˆ†æ
                isCorrectExact: exactAnswerCheck(answer, correctAnswer), // ä¸¥æ ¼åŒ¹é…ç»“æœ
                isCorrectContains: isCorrect // åŒ…å«åŒ¹é…ç»“æœ (å½“å‰ä½¿ç”¨çš„æ ‡å‡†)
            });
            
            // Firebaseè®°å½•
            recordPhase2Answer(
                currentQuestionIndex,
                audioQuestions[currentQuestionIndex].audio,
                answer,
                correctAnswer,
                responseTime,
                playCount // æ–°å¢ï¼šä¼ é€’æ’­æ”¾æ¬¡æ•°
            );
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= audioQuestions.length) {
                goToStage4();
            } else {
                initializeQuestion2();
            }
        }

        function goToStage2() {
            document.getElementById('stage1').classList.remove('active');
            document.getElementById('stage2').classList.add('active');
            
            document.getElementById('progressFill').style.width = '50%';
            document.getElementById('progressText').textContent = 'Review Phase';
            
            startMouseTracking();
            generateAnswerReview();
        }

        function generateAnswerReview() {
            const reviewContainer = document.getElementById('answersReview');
            let reviewHTML = '<div style="line-height: 2.5; font-size: 1.2em;">';
            
            experimentData.round1Answers.forEach((item, index) => {
                const questionText = audioQuestions[item.questionIndex].sentence;
                
                if (item.isCorrect) {
                    const filledSentence = questionText.replace('____', 
                        `<strong style="color: #333; background: rgba(0, 0, 0, 0.05); padding: 2px 6px; border-radius: 4px;">${item.userAnswer}</strong>`);
                    reviewHTML += `<p>${index + 1}. ${filledSentence}</p>`;
                } else {
                    const filledSentence = questionText.replace('____', 
                        `<span class="spell-error-text" onclick="showCorrection(${index}, '${item.correctAnswer}', '${item.userAnswer}')">${item.userAnswer}</span>`);
                    reviewHTML += `<p>${index + 1}. ${filledSentence}</p>`;
                }
            });
            
            reviewHTML += '</div>';
            reviewContainer.innerHTML = reviewHTML;
        }

        function showCorrection(index, correctAnswer, userAnswer) {
            trackReviewClick('spell_check_click', { 
                questionIndex: index, 
                userAnswer: userAnswer, 
                correctAnswer: correctAnswer,
                questionNumber: index + 1 // æ·»åŠ é—®é¢˜å·ç  (1-50)
            });
            
            const existingPopups = document.querySelectorAll('.word-correction-popup');
            existingPopups.forEach(popup => popup.remove());
            
            const popup = document.createElement('div');
            popup.className = 'word-correction-popup';
            popup.innerHTML = `<div class="correction-option">${correctAnswer}</div>`;
            
            const errorElement = event.target;
            const rect = errorElement.getBoundingClientRect();
            popup.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
            popup.style.top = (rect.bottom + 5) + 'px';
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 3000);
            
            experimentData.spellCheckClicks++;
        }

        async function goToStage3() {
            await saveMouseTrackingData();
            
            document.getElementById('stage2').classList.remove('active');
            document.getElementById('stage3').classList.add('active');
            
            currentQuestionIndex = 0;
            currentPhase = 'phase2';
            
            // æ¸…ç©ºé˜¶æ®µ3çš„è¿›åº¦æ˜¾ç¤ºæ–‡æœ¬
            document.getElementById('progressText2').textContent = '';
            
            // ç¡®ä¿åœ¨é¡µé¢åˆ‡æ¢åç«‹å³å¼€å§‹éŸ³é¢‘æ’­æ”¾
            setTimeout(() => {
                initializeQuestion2();
            }, 100);
        }

        function goToStage4() {
            document.getElementById('stage3').classList.remove('active');
            document.getElementById('stage4').classList.add('active');
            
            // ä¿®å¤ï¼šç¡®ä¿æœ€ç»ˆè¿›åº¦æ¡æ˜¾ç¤º100%
            document.getElementById('progressFill2').style.width = '100%';
            document.getElementById('progressText2').textContent = 'Survey Phase';
        }

        // åˆ‡æ¢æ‹¼å†™æ£€æŸ¥å­é—®é¢˜çš„æ˜¾ç¤º
        function toggleSpellCheckerQuestions(show) {
            const subQuestions = document.getElementById('spellCheckerSubQuestions');
            if (subQuestions) {
                subQuestions.style.display = show ? 'block' : 'none';
                
                // å¦‚æœéšè—äº†å­é—®é¢˜ï¼Œæ¸…é™¤å·²é€‰æ‹©çš„ç­”æ¡ˆ
                if (!show) {
                    const checkboxes = subQuestions.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = false);
                    const radios = subQuestions.querySelectorAll('input[type="radio"]');
                    radios.forEach(radio => radio.checked = false);
                    const otherInput = document.getElementById('otherSpellChecker');
                    if (otherInput) {
                        otherInput.value = '';
                        otherInput.disabled = true;
                    }
                }
            }
        }

        // åˆ‡æ¢"å…¶ä»–"è¾“å…¥æ¡†çš„å¯ç”¨çŠ¶æ€
        function toggleOtherInput(checkbox) {
            const otherInput = document.getElementById('otherSpellChecker');
            if (otherInput) {
                otherInput.disabled = !checkbox.checked;
                if (!checkbox.checked) {
                    otherInput.value = '';
                }
            }
        }

        // ä¿®å¤é—®é¢˜2ï¼šæ·»åŠ è°ƒæŸ¥é—®å·å¿…ç­”éªŒè¯
        function validateSurveyAnswers() {
            const requiredQuestions = ['difficulty', 'confidence', 'notice_mistakes', 'use_spell_checker', 'proofreading', 'improvement'];
            let allAnswered = true;
            let missingQuestions = [];
            
            // æ£€æŸ¥åŸºæœ¬å¿…ç­”é¢˜
            for (const questionName of requiredQuestions) {
                const radio = document.querySelector(`input[name="${questionName}"]:checked`);
                if (!radio) {
                    allAnswered = false;
                    missingQuestions.push(questionName);
                }
            }
            
            // æ£€æŸ¥æ¡ä»¶å¿…ç­”é¢˜ï¼šå¦‚æœé€‰æ‹©äº†ä½¿ç”¨æ‹¼å†™æ£€æŸ¥å·¥å…·ï¼Œåˆ™4-2æ˜¯å¿…ç­”çš„
            const useSpellChecker = document.querySelector('input[name="use_spell_checker"]:checked');
            if (useSpellChecker && useSpellChecker.value === 'yes') {
                const spellCheckerHelpful = document.querySelector('input[name="spell_checker_helpful"]:checked');
                if (!spellCheckerHelpful) {
                    allAnswered = false;
                    missingQuestions.push('spell_checker_helpful');
                }
            }
            
            return {
                isValid: allAnswered,
                missingQuestions: missingQuestions
            };
        }

        async function completeExperiment() {
            // ä¿®å¤é—®é¢˜2ï¼šéªŒè¯è°ƒæŸ¥é—®å·æ˜¯å¦å®Œæ•´å¡«å†™
            const validation = validateSurveyAnswers();
            if (!validation.isValid) {
                document.getElementById('surveyErrorMessage').style.display = 'block';
                // æ»šåŠ¨åˆ°é”™è¯¯æ¶ˆæ¯ä½ç½®
                document.getElementById('surveyErrorMessage').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                return;
            }
            
            // éšè—é”™è¯¯æ¶ˆæ¯
            document.getElementById('surveyErrorMessage').style.display = 'none';
            
            const spinner = document.getElementById('submitSpinner');
            const button = event.target;
            
            spinner.style.display = 'inline-block';
            button.disabled = true;
            
            const surveyData = {};
            
            // æ”¶é›†å•é€‰é¢˜ç­”æ¡ˆ
            ['difficulty', 'confidence', 'notice_mistakes', 'use_spell_checker', 'spell_checker_helpful', 'proofreading', 'improvement'].forEach(name => {
                const radio = document.querySelector(`input[name="${name}"]:checked`);
                if (radio) {
                    surveyData[name] = radio.value;
                }
            });
            
            // æ”¶é›†å¤šé€‰é¢˜ç­”æ¡ˆï¼ˆæ‹¼å†™æ£€æŸ¥å·¥å…·ï¼‰
            const spellCheckerTools = [];
            const toolCheckboxes = document.querySelectorAll('input[name="spell_checker_tools"]:checked');
            toolCheckboxes.forEach(checkbox => {
                if (checkbox.value === 'other') {
                    const otherValue = document.getElementById('otherSpellChecker').value.trim();
                    if (otherValue) {
                        spellCheckerTools.push(`other: ${otherValue}`);
                    }
                } else {
                    spellCheckerTools.push(checkbox.value);
                }
            });
            surveyData.spell_checker_tools = spellCheckerTools;
            
            experimentData.surveyResponses = surveyData;
            experimentData.timestamps.experimentComplete = Date.now();
            
            // è®¡ç®—æ’­æ”¾æŒ‰é’®ç»Ÿè®¡æ•°æ®
            experimentData.playButtonStats.averageClicksPerQuestion = 
                (experimentData.playButtonStats.phase1TotalClicks + experimentData.playButtonStats.phase2TotalClicks) / 100;
            
            const completionCode = generateCompletionCode();
            
            // Firebaseä¿å­˜è°ƒæŸ¥æ•°æ®å’Œæ’­æ”¾ç»Ÿè®¡
            if (firebaseInitialized) {
                try {
                    await db.collection('survey_responses').add({
                        sessionId: sessionId,
                        surveyData: surveyData,
                        completionCode: completionCode,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    
                    // ä¿å­˜æ’­æ”¾æŒ‰é’®ç»Ÿè®¡æ•°æ®
                    await recordPlayButtonStats();
                    
                    console.log('ğŸ“‹ è°ƒæŸ¥æ•°æ®å’Œæ’­æ”¾ç»Ÿè®¡å·²ä¿å­˜');
                } catch (error) {
                    console.error('âŒ ä¿å­˜è°ƒæŸ¥æ•°æ®å¤±è´¥:', error);
                }
            }
            
            setTimeout(() => {
                spinner.style.display = 'none';
                button.disabled = false;
                
                document.getElementById('stage4').classList.remove('active');
                document.getElementById('stage5').classList.add('active');
                
                displayFinalResults(completionCode);
            }, 2000);
        }

        function generateCompletionCode() {
            return 'EXP' + Date.now().toString().slice(-6);
        }

        function displayFinalResults(completionCode) {
            const resultsContainer = document.getElementById('finalResults');
            
            const round1Accuracy = calculateAccuracy(experimentData.round1Answers);
            const round2Accuracy = calculateAccuracy(experimentData.round2Answers);
            const overallAccuracy = Math.round(((experimentData.round1Answers.filter(a => a.isCorrect).length + 
                                               experimentData.round2Answers.filter(a => a.isCorrect).length) / 
                                               (experimentData.round1Answers.length + experimentData.round2Answers.length)) * 100);
            
            // è®¡ç®—æ’­æ”¾æŒ‰é’®ç»Ÿè®¡
            const totalPlayClicks = experimentData.playButtonStats.phase1TotalClicks + experimentData.playButtonStats.phase2TotalClicks;
            const avgClicksPerQuestion = (totalPlayClicks / 100).toFixed(1);
            
            resultsContainer.innerHTML = `
                <div class="stats-display">
                    <div class="stat-card">
                        <div class="stat-number">${round1Accuracy}%</div>
                        <div>Phase 1 Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${round2Accuracy}%</div>
                        <div>Phase 2 Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${overallAccuracy}%</div>
                        <div>Overall Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">100</div>
                        <div>Total Questions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${experimentData.spellCheckClicks}</div>
                        <div>Spell Checks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${experimentData.reviewPhaseClicks.length}</div>
                        <div>Review Clicks</div>
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; margin-top: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 1.4em;">ğŸ¯ Completion Code for Prolific:</h3>
                    <div style="background: rgba(255,255,255,0.9); color: #333; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 1.5em; font-weight: bold; text-align: center; letter-spacing: 2px;">
                        ${completionCode}
                    </div>
                    <p style="margin-top: 15px; font-size: 1.1em;">
                        Please copy this code and paste it into Prolific to receive your payment.
                    </p>
                </div>
                
                <p style="margin-top: 25px; font-size: 1.1em;">
                    <strong>Participant ID:</strong> ${experimentData.participantId}<br>
                    <strong>Session ID:</strong> ${sessionId}<br>
                    <strong>Firebase Status:</strong> ${firebaseInitialized ? 'âœ… Connected' : 'âŒ Not Connected'}
                </p>
            `;
        }

        // é”®ç›˜å¯¼èˆª
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeStage = document.querySelector('.stage.active');
                if (activeStage) {
                    const stageId = activeStage.id;
                    
                    if (stageId === 'stage1') {
                        const input = document.getElementById('answerInput');
                        if (input && document.activeElement === input) {
                            nextQuestion();
                        }
                    } else if (stageId === 'stage3') {
                        const input = document.getElementById('answerInput2');
                        if (input && document.activeElement === input) {
                            nextQuestion2();
                        }
                    }
                }
            }
        });

        function enableAudio() {
            const silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAAAQQBEAEEAhAIBAQEAAQAAAQABAAABAAgABgAGAAYABgAGAA==');
            silentAudio.volume = 0;
            silentAudio.play().then(() => {
                console.log('Audio context enabled');
            }).catch(() => {
                console.log('Audio context failed to enable');
            });
        }

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ§ Audio Listening Experiment v8.5 - Enhanced Stage Indicators');
            
            // åˆå§‹åŒ–Firebase
            const firebaseReady = await initializeFirebase();
            
            if (firebaseReady) {
                console.log('âœ… Firebaseå·²å°±ç»ªï¼Œå¼€å§‹è®°å½•æ•°æ®');
            } else {
                console.log('âš ï¸ Firebaseæœªå°±ç»ªï¼Œå®éªŒå°†åœ¨æ— æ•°æ®è®°å½•æ¨¡å¼ä¸‹è¿è¡Œ');
            }
            
            // å¯ç”¨éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·äº¤äº’åï¼‰
            document.addEventListener('click', enableAudio, { once: true });
            document.addEventListener('keydown', enableAudio, { once: true });
            
            // æ˜¾ç¤ºæ¬¢è¿é¡µé¢ï¼Œä¸è‡ªåŠ¨å¼€å§‹å®éªŒ
            console.log('æ˜¾ç¤ºæ¬¢è¿é¡µé¢ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥Prolific ID');
        });

        // é¡µé¢ç¦»å¼€æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (countdownTimer) clearInterval(countdownTimer);
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
        });
    </script>
</body>
</html>
                
