<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Listening Experiment v8.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            max-width: 900px;
            width: 90%;
            margin: 20px;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        }

        .header {
            text-align: center;
            margin-bottom: 35px;
        }

        .header h1 {
            color: #333;
            font-size: 2.8em;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .stage {
            display: none;
        }

        .stage.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .progress-container {
            margin-bottom: 35px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e8ecf4;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .question-card {
            background: linear-gradient(145deg, #f8f9ff, #ffffff);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            position: relative;
        }

        .question-number {
            color: #667eea;
            font-weight: 700;
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-number::before {
            content: '🎯';
            font-size: 1.2em;
        }

        .round-indicator {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: auto;
        }

        .audio-controls {
            text-align: center;
            margin: 25px 0;
        }

        .play-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 240px;
        }

        .play-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .play-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .countdown-circle {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sentence-display {
            font-size: 1.4em;
            margin: 30px 0;
            text-align: center;
            line-height: 2.2;
            padding: 25px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid rgba(102, 126, 234, 0.08);
        }

        .input-field {
            display: inline-block;
            border: none;
            border-bottom: 3px solid #667eea;
            background: linear-gradient(145deg, #ffffff, #f8f9ff);
            font-size: 1.3em;
            padding: 12px 16px;
            margin: 0 10px;
            min-width: 160px;
            max-width: 220px;
            width: auto;
            text-align: center;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .input-field:focus {
            border-bottom-color: #764ba2;
            background: linear-gradient(145deg, #f8f9ff, #ffffff);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);
            transform: translateY(-2px);
        }

        .input-field.spell-error {
            border-bottom: 3px wavy #e74c3c !important;
            background-color: rgba(231, 76, 60, 0.08) !important;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .spell-error-text {
            border-bottom: 3px wavy #e74c3c !important;
            background-color: rgba(231, 76, 60, 0.08) !important;
            padding: 3px 6px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            position: relative !important;
        }

        .spell-error-text:hover {
            background-color: rgba(231, 76, 60, 0.15) !important;
            transform: translateY(-1px);
        }

        .word-correction-popup {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: popupFadeIn 0.4s ease;
            min-width: 150px;
        }

        @keyframes popupFadeIn {
            from { opacity: 0; transform: translateY(-10px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .correction-option {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            color: #28a745;
            cursor: pointer;
        }

        .correction-option:hover {
            background-color: #f8f9fa;
        }

        .next-button, .submit-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            margin: 25px 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .next-button:hover, .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
        }

        .feedback-section {
            background: linear-gradient(145deg, #e8f5e8, #f0f8f0);
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #28a745;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.1);
        }

        .survey-section {
            background: linear-gradient(145deg, #fff3cd, #fffadc);
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border-left: 6px solid #ffc107;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.1);
        }

        .survey-question {
            margin: 25px 0;
        }

        .survey-question label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .survey-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
            resize: vertical;
        }

        .survey-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .radio-option:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .completion-message {
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 24px;
            box-shadow: 0 15px 40px rgba(40, 167, 69, 0.3);
        }

        .completion-message h2 {
            font-size: 3em;
            margin-bottom: 25px;
        }

        .completion-message p {
            font-size: 1.3em;
        }

        .button-group {
            text-align: center;
            margin-top: 25px;
        }

        .info-text {
            text-align: center;
            color: #666;
            margin: 25px 0;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: linear-gradient(145deg, #f8f9ff, #ffffff);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        .accuracy-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .accuracy-indicator.good {
            color: #28a745;
            border-left: 4px solid #28a745;
        }

        .accuracy-indicator.average {
            color: #ffc107;
            border-left: 4px solid #ffc107;
        }

        .accuracy-indicator.poor {
            color: #dc3545;
            border-left: 4px solid #dc3545;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 15px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .sentence-display {
                font-size: 1.2em;
                padding: 20px;
            }
            
            .input-field {
                min-width: 140px;
                max-width: 180px;
                font-size: 1.1em;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .play-button {
                min-width: 200px;
                padding: 15px 25px;
            }

            .stats-display {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎧 Audio Listening Experiment <span class="version-badge">v8.0</span></h1>
            <p class="info-text">厳格判定システム • 自動再生機能 • 100問総計 (50問 × 2ラウンド)</p>
        </div>

        <div class="progress-container">
            <div class="progress-info">
                <span id="progressText">Round 1: Question 1 / 50</span>
                <span id="accuracyDisplay">Accuracy: 0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Stage 1: Audio Fill-in-the-Blank Test - Round 1 -->
        <div class="stage active" id="stage1">
            <div class="question-card">
                <div class="accuracy-indicator good" id="accuracyIndicator">
                    Accuracy: 0%
                </div>
                <div class="question-number" id="questionNumber">
                    Question 1 / 50
                    <span class="round-indicator">Round 1</span>
                </div>
                <div class="audio-controls">
                    <button class="play-button" id="playButton" onclick="playAudio()">
                        🔊 Auto-play in <span id="countdown">3</span>s
                    </button>
                </div>
                <div class="sentence-display" id="sentenceDisplay">
                    Loading question...
                </div>
                <div class="error-message" id="errorMessage">
                    Please fill in the blank before proceeding to the next question.
                </div>
                <div class="button-group">
                    <button class="next-button" onclick="nextQuestion()">Next Question →</button>
                </div>
            </div>
        </div>

        <!-- Stage 2: Answer Review and Spell Check -->
        <div class="stage" id="stage2">
            <div class="feedback-section">
                <h2>📝 Round 1 Results - Spell Check Review</h2>
                <p><strong>厳格判定:</strong> 完全一致のみ正解 | <strong>スペルチェック:</strong> 赤い波線をクリックして正解を確認</p>
                <div id="answersReview"></div>
                <div class="button-group">
                    <button class="next-button" onclick="goToStage3()">Continue to Round 2 →</button>
                </div>
            </div>
        </div>

        <!-- Stage 3: Second Round Test -->
        <div class="stage" id="stage3">
            <div class="question-card">
                <div class="accuracy-indicator good" id="accuracyIndicator2">
                    Round 2 Accuracy: 0%
                </div>
                <div class="question-number" id="questionNumber2">
                    Question 1 / 50
                    <span class="round-indicator" style="background: linear-gradient(45deg, #dc3545, #e74c3c);">Round 2</span>
                </div>
                <div class="audio-controls">
                    <button class="play-button" id="playButton2" onclick="playAudio2()">
                        🔊 Auto-play in <span id="countdown2">3</span>s
                    </button>
                </div>
                <div class="sentence-display" id="sentenceDisplay2">
                    Loading question...
                </div>
                <div class="error-message" id="errorMessage2">
                    Please fill in the blank before proceeding to the next question.
                </div>
                <div class="button-group">
                    <button class="next-button" onclick="nextQuestion2()">Next Question →</button>
                </div>
            </div>
        </div>

        <!-- Stage 4: Post-Experiment Survey -->
        <div class="stage" id="stage4">
            <div class="survey-section">
                <h2>📋 Post-Experiment Survey</h2>
                <p class="info-text">Total Questions Completed: <strong>100 questions</strong> (50 × 2 rounds)</p>
                
                <div class="survey-question">
                    <label>1. How difficult did you find this experiment?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="very_easy"> Very Easy
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="easy"> Easy
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="medium"> Medium
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="hard"> Hard
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="very_hard"> Very Hard
                        </label>
                    </div>
                </div>

                <div class="survey-question">
                    <label>2. How was the auto-play audio feature?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="excellent"> Excellent
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="good"> Good
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="fair"> Fair
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="audio_feature" value="poor"> Poor
                        </label>
                    </div>
                </div>

                <div class="survey-question">
                    <label>3. Did the strict answer matching system work well?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="very_helpful"> Very Helpful
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="helpful"> Helpful
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="neutral"> Neutral
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="strict_matching" value="not_helpful"> Not Helpful
                        </label>
                    </div>
                </div>

                <div class="survey-question">
                    <label>4. Additional comments about the experiment:</label>
                    <textarea class="survey-input" rows="4" id="additionalComments" placeholder="Please share your feedback about the 100-question experiment..."></textarea>
                </div>

                <div class="button-group">
                    <button class="submit-button" onclick="completeExperiment()">
                        <span class="loading-spinner" id="submitSpinner"></span>
                        Submit Final Results ✓
                    </button>
                </div>
            </div>
        </div>

        <!-- Completion Stage -->
        <div class="stage" id="stage5">
            <div class="completion-message">
                <h2>🎉 Experiment Complete!</h2>
                <p>100 questions completed with strict answer matching!</p>
                <div id="finalResults"></div>
            </div>
        </div>
    </div>

    <script>
        // System configuration
        const SYSTEM_CONFIG = {
            strictMatching: true,        // ✅ 厳格な答え判定：正確一致のみ正解
            autoPlayCountdown: 3,        // ✅ 自動再生機能：3秒カウントダウン
            spellCheckEnabled: true,     // ✅ スペルチェック：赤い波線で間違い表示
            totalRounds: 2,              // ✅ 2ラウンド制
            questionsPerRound: 50        // ✅ 50問 × 2 = 100問総計
        };

        // Experiment data storage
        let experimentData = {
            participantId: 'P' + Date.now(),
            version: '8.0',
            systemConfig: SYSTEM_CONFIG,
            round1Answers: [],
            round2Answers: [],
            surveyResponses: {},
            timestamps: {
                start: Date.now(),
                round1Complete: null,
                round2Complete: null,
                experimentComplete: null
            },
            spellCheckClicks: 0,
            autoPlayCount: 0,
            userAgent: navigator.userAgent,
            screenResolution: `${screen.width}x${screen.height}`,
            language: navigator.language
        };

        // Audio questions - All 50 questions
        const audioQuestions = [
            { sentence: "The government has ____ that the new tax policy has been a disaster", answer: "conceded", difficulty: "hard", category: "politics" },
            { sentence: "He's got a lot of ____ degrees and awards from educational establishments worldwide", answer: "honorary", difficulty: "medium", category: "education" },
            { sentence: "As people ____ more wealth, they tend to spend a greater proportion of their incomes", answer: "accumulate", difficulty: "medium", category: "economics" },
            { sentence: "Plant growth is most ____ in spring and early summer", answer: "noticeable", difficulty: "medium", category: "nature" },
            { sentence: "The ____ is to perform its last ever concert tomorrow night at the Albert Hall", answer: "orchestra", difficulty: "medium", category: "music" },
            { sentence: "Public ____ about the disease is still a cause for concern", answer: "ignorance", difficulty: "medium", category: "health" },
            { sentence: "The president does not want to answer any ____ questions", answer: "theoretical", difficulty: "hard", category: "politics" },
            { sentence: "Education should be ____ to the child's needs", answer: "relevant", difficulty: "medium", category: "education" },
            { sentence: "His father is buried in the ____ on the hill", answer: "cemetery", difficulty: "easy", category: "places" },
            { sentence: "Although the play was written hundreds of years ago, it still has a ____ feel to it", answer: "contemporary", difficulty: "hard", category: "arts" },
            { sentence: "He is blessed with both good looks and ____", answer: "intelligence", difficulty: "medium", category: "personal" },
            { sentence: "He was brought up on a diet of political ____ from birth", answer: "propaganda", difficulty: "hard", category: "politics" },
            { sentence: "This recipe should be ____ for five people", answer: "sufficient", difficulty: "medium", category: "cooking" },
            { sentence: "Young people don't always appreciate the ____ offered by their parents and teachers", answer: "guidance", difficulty: "medium", category: "education" },
            { sentence: "Not making a will can have serious ____ for your children and other family members", answer: "consequences", difficulty: "medium", category: "legal" },
            { sentence: "The country is run on socialist ____", answer: "principles", difficulty: "hard", category: "politics" },
            { sentence: "Any help you could give me would be greatly ____", answer: "appreciated", difficulty: "easy", category: "courtesy" },
            { sentence: "He was arrested for taking part in ____ activities", answer: "revolutionary", difficulty: "hard", category: "politics" },
            { sentence: "I think it helps if you have an ____ personality", answer: "extroverted", difficulty: "medium", category: "personality" },
            { sentence: "With the extra resources, the project now seems ____", answer: "feasible", difficulty: "hard", category: "business" },
            { sentence: "That party was too ____ for me!", answer: "bizarre", difficulty: "medium", category: "description" },
            { sentence: "The finance ____ controls the school's budget", answer: "committee", difficulty: "medium", category: "organization" },
            { sentence: "I like the ____ of living close to work", answer: "convenience", difficulty: "easy", category: "lifestyle" },
            { sentence: "It was when we started living together that we found we just weren't ____", answer: "compatible", difficulty: "medium", category: "relationships" },
            { sentence: "He told one or two ____ stories about his years as a policeman", answer: "humorous", difficulty: "medium", category: "personality" },
            { sentence: "We really ought to leave ____", answer: "immediately", difficulty: "medium", category: "time" },
            { sentence: "An ____ inquiry will determine whether the case should move forward", answer: "independent", difficulty: "medium", category: "legal" },
            { sentence: "He decided to ____ a career in television", answer: "pursue", difficulty: "medium", category: "career" },
            { sentence: "She has shown herself to be a highly ____ manager", answer: "competent", difficulty: "medium", category: "work" },
            { sentence: "The children have no ____ of being different", answer: "consciousness", difficulty: "hard", category: "psychology" },
            { sentence: "An old ____ for 2012 was still hanging on the wall of her office", answer: "calendar", difficulty: "easy", category: "office" },
            { sentence: "The general ____ in the office is that he can't do his job", answer: "consensus", difficulty: "hard", category: "opinion" },
            { sentence: "The sun ____ behind heavy clouds", answer: "disappeared", difficulty: "easy", category: "weather" },
            { sentence: "I'm sorry to ____ you, but I'm afraid I can't come after all", answer: "disappoint", difficulty: "medium", category: "emotions" },
            { sentence: "Such a war would be ____ for the country", answer: "disastrous", difficulty: "medium", category: "consequences" },
            { sentence: "Some monkeys have a very complex social ____", answer: "hierarchy", difficulty: "hard", category: "social" },
            { sentence: "We met on several ____ to discuss the issue", answer: "occasions", difficulty: "medium", category: "time" },
            { sentence: "I had the ____ of interviewing Picasso in the 1960s", answer: "privilege", difficulty: "medium", category: "opportunity" },
            { sentence: "Store fruit juice in the ____", answer: "refrigerator", difficulty: "easy", category: "household" },
            { sentence: "I didn't want to ____ her in front of her friends", answer: "embarrass", difficulty: "medium", category: "emotions" },
            { sentence: "The art department and the music department are in two ____ buildings", answer: "separate", difficulty: "easy", category: "location" },
            { sentence: "She ____ for her husband's rudeness", answer: "apologized", difficulty: "medium", category: "behavior" },
            { sentence: "I'll be living here for the ____ future", answer: "foreseeable", difficulty: "hard", category: "time" },
            { sentence: "She gave me one of those ____ smiles and I just had to agree", answer: "irresistible", difficulty: "hard", category: "description" },
            { sentence: "Imagine what the world will be like at the end of the next ____", answer: "millennium", difficulty: "hard", category: "time" },
            { sentence: "There are two different ____ of this word", answer: "pronunciations", difficulty: "medium", category: "language" },
            { sentence: "Visitors to the country have been asked to fill out a detailed ____", answer: "questionnaire", difficulty: "medium", category: "documentation" },
            { sentence: "He ____ said he'd be here", answer: "definitely", difficulty: "medium", category: "certainty" },
            { sentence: "Death was an everyday ____ during the Civil War", answer: "occurrence", difficulty: "medium", category: "events" }
        ];

        // Current question tracking
        let currentQuestionIndex = 0;
        let currentRound = 1;
        let countdownTimer = null;
        let autoPlayTimer = null;

        // ✅ 厳格な答え判定：正確一致のみ正解
        function strictAnswerCheck(userAnswer, correctAnswer) {
            if (!SYSTEM_CONFIG.strictMatching) {
                return userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim();
            }
            // 厳格判定: 大文字小文字、スペース、句読点まで完全一致
            return userAnswer.trim() === correctAnswer.trim();
        }

        // Calculate accuracy for display
        function calculateAccuracy(answers) {
            if (answers.length === 0) return 0;
            const correct = answers.filter(answer => 
                strictAnswerCheck(answer.userAnswer, answer.correctAnswer)
            ).length;
            return Math.round((correct / answers.length) * 100);
        }

        // Update accuracy indicator
        function updateAccuracyDisplay(accuracy, elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `Accuracy: ${accuracy}%`;
                element.className = 'accuracy-indicator ' + 
                    (accuracy >= 80 ? 'good' : accuracy >= 60 ? 'average' : 'poor');
            }
        }

        // ✅ 自動再生機能：1秒カウントダウン
        function startCountdown(buttonId, countdownId, callback) {
            const button = document.getElementById(buttonId);
            const countdownElement = document.getElementById(countdownId);
            
            if (!button || !countdownElement) return;
            
            let timeLeft = SYSTEM_CONFIG.autoPlayCountdown;
            countdownElement.textContent = timeLeft;
            
            // Clear any existing timers
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    button.innerHTML = '<span class="countdown-circle"></span>Playing Audio...';
                    button.disabled = true;
                    
                    // Auto-play audio after countdown
                    autoPlayTimer = setTimeout(() => {
                        button.textContent = '🔊 Play Again';
                        button.disabled = false;
                        experimentData.autoPlayCount++;
                        if (callback) callback();
                    }, 2500);
                }
            }, 1000);
        }

        // Initialize first question (Round 1)
        function initializeQuestion() {
            if (currentQuestionIndex < audioQuestions.length) {
                const question = audioQuestions[currentQuestionIndex];
                const sentenceWithBlank = question.sentence.replace('____', 
                    '<input type="text" class="input-field" id="answerInput" placeholder="____" autocomplete="off" spellcheck="false">');
                
                document.getElementById('sentenceDisplay').innerHTML = sentenceWithBlank;
                document.getElementById('questionNumber').innerHTML = 
                    `Question ${currentQuestionIndex + 1} / ${audioQuestions.length} <span class="round-indicator">Round 1</span>`;
                
                // Update progress (0-50%)
                const progress = (currentQuestionIndex / audioQuestions.length) * 50;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `Round 1: Question ${currentQuestionIndex + 1} / ${audioQuestions.length}`;
                
                // Update accuracy display
                const accuracy = calculateAccuracy(experimentData.round1Answers);
                document.getElementById('accuracyDisplay').textContent = `Accuracy: ${accuracy}%`;
                updateAccuracyDisplay(accuracy, 'accuracyIndicator');
                
                // Clear error message
                document.getElementById('errorMessage').style.display = 'none';
                
                // Start auto-play countdown
                startCountdown('playButton', 'countdown', () => {
                    const input = document.getElementById('answerInput');
                    if (input) input.focus();
                });
                
                // Focus on input after delay
                setTimeout(() => {
                    const input = document.getElementById('answerInput');
                    if (input) input.focus();
                }, 100);
            }
        }

        // Initialize second round question
        function initializeQuestion2() {
            if (currentQuestionIndex < audioQuestions.length) {
                const question = audioQuestions[currentQuestionIndex];
                const sentenceWithBlank = question.sentence.replace('____', 
                    '<input type="text" class="input-field" id="answerInput2" placeholder="____" autocomplete="off" spellcheck="false">');
                
                document.getElementById('sentenceDisplay2').innerHTML = sentenceWithBlank;
                document.getElementById('questionNumber2').innerHTML = 
                    `Question ${currentQuestionIndex + 1} / ${audioQuestions.length} <span class="round-indicator" style="background: linear-gradient(45deg, #dc3545, #e74c3c);">Round 2</span>`;
                
                // Update progress (50-100%)
                const progress = 50 + (currentQuestionIndex / audioQuestions.length) * 50;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `Round 2: Question ${currentQuestionIndex + 1} / ${audioQuestions.length}`;
                
                // Update accuracy display
                const accuracy = calculateAccuracy(experimentData.round2Answers);
                updateAccuracyDisplay(accuracy, 'accuracyIndicator2');
                
                // Clear error message
                document.getElementById('errorMessage2').style.display = 'none';
                
                // Start auto-play countdown
                startCountdown('playButton2', 'countdown2', () => {
                    const input = document.getElementById('answerInput2');
                    if (input) input.focus();
                });
                
                // Focus on input after delay
                setTimeout(() => {
                    const input = document.getElementById('answerInput2');
                    if (input) input.focus();
                }, 100);
            }
        }

        // Play audio function (Round 1)
        function playAudio() {
            const button = document.getElementById('playButton');
            
            // Clear timers
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
            
            button.innerHTML = '<span class="countdown-circle"></span>Playing Audio...';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = '🔊 Play Again';
                button.disabled = false;
                
                const input = document.getElementById('answerInput');
                if (input) {
                    input.placeholder = 'Type the missing word...';
                    input.focus();
                }
            }, 2500);
        }

        // Play audio function (Round 2)
        function playAudio2() {
            const button = document.getElementById('playButton2');
            
            // Clear timers
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
            
            button.innerHTML = '<span class="countdown-circle"></span>Playing Audio...';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = '🔊 Play Again';
                button.disabled = false;
                
                const input = document.getElementById('answerInput2');
                if (input) {
                    input.placeholder = 'Type the missing word...';
                    input.focus();
                }
            }, 2500);
        }

        // Next question function (Round 1)
        function nextQuestion() {
            const input = document.getElementById('answerInput');
            const answer = input ? input.value.trim() : '';
            
            if (!answer) {
                document.getElementById('errorMessage').style.display = 'block';
                if (input) {
                    input.classList.add('spell-error');
                    setTimeout(() => input.classList.remove('spell-error'), 500);
                    input.focus();
                }
                return;
            }
            
            // Clear timers
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
            
            // Store answer with strict checking
            const correctAnswer = audioQuestions[currentQuestionIndex].answer;
            const isCorrect = strictAnswerCheck(answer, correctAnswer);
            
            experimentData.round1Answers.push({
                questionIndex: currentQuestionIndex,
                userAnswer: answer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: Date.now()
            });
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= audioQuestions.length) {
                // Round 1 complete
                experimentData.timestamps.round1Complete = Date.now();
                goToStage2();
            } else {
                initializeQuestion();
            }
        }

        // Next question function (Round 2)
        function nextQuestion2() {
            const input = document.getElementById('answerInput2');
            const answer = input ? input.value.trim() : '';
            
            if (!answer) {
                document.getElementById('errorMessage2').style.display = 'block';
                if (input) {
                    input.classList.add('spell-error');
                    setTimeout(() => input.classList.remove('spell-error'), 500);
                    input.focus();
                }
                return;
            }
            
            // Clear timers
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
            
            // Store answer with strict checking
            const correctAnswer = audioQuestions[currentQuestionIndex].answer;
            const isCorrect = strictAnswerCheck(answer, correctAnswer);
            
            experimentData.round2Answers.push({
                questionIndex: currentQuestionIndex,
                userAnswer: answer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timestamp: Date.now()
            });
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= audioQuestions.length) {
                // Round 2 complete
                experimentData.timestamps.round2Complete = Date.now();
                goToStage4();
            } else {
                initializeQuestion2();
            }
        }

        // Go to stage 2 (review)
        function goToStage2() {
            document.getElementById('stage1').classList.remove('active');
            document.getElementById('stage2').classList.add('active');
            
            // Update progress to 50%
            document.getElementById('progressFill').style.width = '50%';
            document.getElementById('progressText').textContent = 'Round 1 Complete - Review Phase';
            
            // Generate review content
            generateAnswerReview();
        }

        // ✅ スペルチェック：赤い波線で間違い表示
        function generateAnswerReview() {
            const reviewContainer = document.getElementById('answersReview');
            let reviewHTML = '<div style="line-height: 2.5; font-size: 1.2em;">';
            
            const round1Accuracy = calculateAccuracy(experimentData.round1Answers);
            reviewHTML += `<div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                <strong>Round 1 Results:</strong> ${round1Accuracy}% accuracy (${experimentData.round1Answers.filter(a => a.isCorrect).length}/${experimentData.round1Answers.length} correct)
            </div>`;
            
            experimentData.round1Answers.forEach((item, index) => {
                const questionText = audioQuestions[item.questionIndex].sentence;
                
                if (item.isCorrect) {
                    const filledSentence = questionText.replace('____', 
                        `<strong style="color: #28a745; background: rgba(40, 167, 69, 0.1); padding: 2px 6px; border-radius: 4px;">${item.userAnswer}</strong>`);
                    reviewHTML += `<p>${index + 1}. ${filledSentence}</p>`;
                } else {
                    const filledSentence = questionText.replace('____', 
                        `<span class="spell-error-text" onclick="showCorrection(${index}, '${item.correctAnswer}', '${item.userAnswer}')">${item.userAnswer}</span>`);
                    reviewHTML += `<p>${index + 1}. ${filledSentence}</p>`;
                }
            });
            
            reviewHTML += '</div>';
            reviewContainer.innerHTML = reviewHTML;
        }

        // Show correction popup
        function showCorrection(index, correctAnswer, userAnswer) {
            // Remove any existing popups
            const existingPopups = document.querySelectorAll('.word-correction-popup');
            existingPopups.forEach(popup => popup.remove());
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'word-correction-popup';
            popup.innerHTML = `
                <div class="correction-option">❌ Your answer: ${userAnswer}</div>
                <div class="correction-option">✅ Correct: ${correctAnswer}</div>
            `;
            
            // Position popup
            const errorElement = event.target;
            const rect = errorElement.getBoundingClientRect();
            popup.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
            popup.style.top = (rect.bottom + 5) + 'px';
            
            document.body.appendChild(popup);
            
            // Remove popup after 4 seconds
            setTimeout(() => {
                popup.remove();
            }, 4000);
            
            // Track spell check interaction
            experimentData.spellCheckClicks++;
        }

        // Go to stage 3 (Round 2)
        function goToStage3() {
            document.getElementById('stage2').classList.remove('active');
            document.getElementById('stage3').classList.add('active');
            
            // Reset question index for Round 2
            currentQuestionIndex = 0;
            currentRound = 2;
            
            // Update progress display
            document.getElementById('progressText').textContent = 'Round 2: Starting...';
            
            initializeQuestion2();
        }

        // Go to stage 4 (survey)
        function goToStage4() {
            document.getElementById('stage3').classList.remove('active');
            document.getElementById('stage4').classList.add('active');
            
            // Update progress to 100%
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = 'Experiment Complete - Survey Phase';
            
            // Clear any remaining timers
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
        }

        // Complete experiment
        function completeExperiment() {
            const spinner = document.getElementById('submitSpinner');
            const button = event.target;
            
            spinner.style.display = 'inline-block';
            button.disabled = true;
            
            // Collect survey responses
            const surveyData = {};
            
            ['difficulty', 'audio_feature', 'strict_matching'].forEach(name => {
                const radio = document.querySelector(`input[name="${name}"]:checked`);
                if (radio) surveyData[name] = radio.value;
            });
            
            surveyData.additionalComments = document.getElementById('additionalComments').value;
            experimentData.surveyResponses = surveyData;
            experimentData.timestamps.experimentComplete = Date.now();
            
            // Simulate data submission
            setTimeout(() => {
                spinner.style.display = 'none';
                button.disabled = false;
                
                // Go to completion stage
                document.getElementById('stage4').classList.remove('active');
                document.getElementById('stage5').classList.add('active');
                
                displayFinalResults();
                console.log('Experiment Data:', experimentData);
            }, 2000);
        }

        // Display final results
        function displayFinalResults() {
            const resultsContainer = document.getElementById('finalResults');
            
            const round1Accuracy = calculateAccuracy(experimentData.round1Answers);
            const round2Accuracy = calculateAccuracy(experimentData.round2Answers);
            const overallAccuracy = Math.round(((experimentData.round1Answers.filter(a => a.isCorrect).length + 
                                               experimentData.round2Answers.filter(a => a.isCorrect).length) / 
                                               (experimentData.round1Answers.length + experimentData.round2Answers.length)) * 100);
            
            const totalTime = Math.round((experimentData.timestamps.experimentComplete - experimentData.timestamps.start) / 1000 / 60);
            
            resultsContainer.innerHTML = `
                <div class="stats-display">
                    <div class="stat-card">
                        <div class="stat-number">${round1Accuracy}%</div>
                        <div>Round 1 Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${round2Accuracy}%</div>
                        <div>Round 2 Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${overallAccuracy}%</div>
                        <div>Overall Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">100</div>
                        <div>Total Questions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalTime}</div>
                        <div>Minutes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${experimentData.spellCheckClicks}</div>
                        <div>Spell Checks</div>
                    </div>
                </div>
                <p style="margin-top: 25px; font-size: 1.1em; color: rgba(255,255,255,0.9);">
                    <strong>Strict Matching:</strong> ${SYSTEM_CONFIG.strictMatching ? 'Enabled' : 'Disabled'} | 
                    <strong>Auto-plays:</strong> ${experimentData.autoPlayCount} | 
                    <strong>Participant ID:</strong> ${experimentData.participantId}
                </p>
            `;
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeStage = document.querySelector('.stage.active');
                if (activeStage) {
                    const stageId = activeStage.id;
                    
                    if (stageId === 'stage1') {
                        const input = document.getElementById('answerInput');
                        if (input && document.activeElement === input) {
                            nextQuestion();
                        }
                    } else if (stageId === 'stage3') {
                        const input = document.getElementById('answerInput2');
                        if (input && document.activeElement === input) {
                            nextQuestion2();
                        }
                    }
                }
            }
        });

        // Initialize experiment when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎧 Audio Listening Experiment v8.0 - System Specifications:');
            console.log('✅ 厳格な答え判定：正確一致のみ正解');
            console.log('✅ 自動再生機能：3秒カウントダウン');
            console.log('✅ スペルチェック：赤い波線で間違い表示');
            console.log('✅ 2ラウンド制：50問 × 2 = 100問総計');
            
            initializeQuestion();
        });

        // Cleanup timers when page unloads
        window.addEventListener('beforeunload', function() {
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoPlayTimer) clearTimeout(autoPlayTimer);
        });
    </script>
</body>
</html>
